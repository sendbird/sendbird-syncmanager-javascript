/**
 * Copyright(c) 2016 SendBird, Inc.
 * SendBird SyncManager JavaScript SDK v1.1.21
 */

!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).SendBirdSyncManager=n()}(this,function(){"use strict";function f(e){return(f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function r(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,n,t){return n&&r(e.prototype,n),t&&r(e,t),e}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,n){return(o=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function u(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function i(e,n,t){return(i=u()?Reflect.construct:function(e,n,t){var r=[null];r.push.apply(r,n);r=new(Function.bind.apply(e,r));return t&&o(r,t.prototype),r}).apply(null,arguments)}function n(e){var r="function"==typeof Map?new Map:void 0;return(n=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return i(e,arguments,s(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),o(t,e)})(e)}function h(e,n){return!n||"object"!=typeof n&&"function"!=typeof n?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):n}function q(e){return function(e){if(Array.isArray(e))return a(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||d(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(e,n){if(e){if("string"==typeof e)return a(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?a(e,n):void 0}}function a(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function p(e,n){var t;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(t=d(e))||n&&e&&"number"==typeof e.length){t&&(e=t);var r=0,n=function(){};return{s:n,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){t=e[Symbol.iterator]()},n:function(){var e=t.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==t.return||t.return()}finally{if(s)throw i}}}}var t=64,g=200,v=128,y=32,m=null,k=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return l(this,n),m=m||this,this.batchSize=t,this.batchInterval=g,this.cachedBlockLimit=v,this.cachedBlockFlush=y,this.encryption={encrypt:function(e,n){return n(null,e)},decrypt:function(e,n){return n(null,e)}},"number"==typeof e.batchSize&&1<e.batchSize&&(this.batchSize=e.batchSize),"number"==typeof e.batchInterval&&10<e.batchInterval&&(this.batchInterval=e.batchInterval),"number"==typeof e.cachedBlockLimit&&0<e.cachedBlockLimit&&(this.cachedBlockLimit=e.cachedBlockLimit),"number"==typeof e.cachedBlockFlush&&e.cachedBlockFlush<this.cachedBlockLimit&&(this.cachedBlockFlush=e.cachedBlockFlush),e.encryption&&e.encryption.hasOwnProperty("encrypt")&&e.encryption.hasOwnProperty("decrypt")&&"function"==typeof e.encryption.encrypt&&"function"==typeof e.encryption.decrypt&&(this.encryption=e.encryption),m}return c(n,null,[{key:"getInstance",value:function(){return m}}]),n}(),I={PENDING:0,FULFILLED:1,REJECTED:2},e=function(){function u(e){var n=this;l(this,u),this.state=I.PENDING,this._value=null,this._reason=null;if("function"!=typeof e)throw"Promise resolver ".concat(e," is not a function");e(function(e){n.state===I.PENDING&&(n.state=I.FULFILLED,n._value=e)},function(e){n.state===I.PENDING&&(n.state=I.REJECTED,n._reason=e)})}return c(u,[{key:"then",value:function(e,n){var t=this,r=this;switch(this.state){case I.PENDING:setTimeout(function(){return t.then(e,n)},100);break;case I.FULFILLED:e&&"function"==typeof e&&(r=e(this._value));break;case I.REJECTED:n&&"function"==typeof n&&(r=n(this._reason))}return r instanceof u?r:this}},{key:"catch",value:function(e){var n=this,t=this;switch(this.state){case I.PENDING:setTimeout(function(){return n.catch(e)},100);break;case I.FULFILLED:break;case I.REJECTED:t=e(this._reason)}return t instanceof u?t:this}},{key:"finally",value:function(e){var n=this,t=this;switch(this.state){case I.PENDING:setTimeout(function(){return n.finally(e)},100);break;case I.FULFILLED:case I.REJECTED:t=e()}return t instanceof u?t:this}},{key:"length",get:function(){return 1}}],[{key:"all",value:function(o){return new u(function(r,i){if(Array.isArray(o)||"string"==typeof o)if(0<o.length){var e,n=[];for(e in o)o[e]instanceof u?n.push(o[e]):n.push(u.resolve(o[e]));var a=new Array(n.length).fill(null),s=n.length,t=function(e,n,t){n?i(n):(s--,a[e]=t,s<=0&&r(a))};n.forEach(function(e,n){e.then(function(e){t(n,null,e)}).catch(function(e){t(n,e,null)})})}else r([]);else i(new Error("Uncaught (in promise) TypeError: ".concat(f(o)," ").concat(o," is not iterable")))})}},{key:"resolve",value:function(n){return new u(function(e){e(n)})}},{key:"reject",value:function(t){return new u(function(e,n){n(t)})}}]),u}();"undefined"==typeof Promise&&(Promise=e);var b="undefined"!=typeof setImmediate?setImmediate:function(e){return setTimeout(e,1)};function E(n,t){var e=f(n),r=f(t);return!n||!t||"object"!==e||e!==r||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===e&&"function"===r||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(e){return E(n[e],t[e])})}function C(e){return null!=e}function w(e,t,i){if(!t)return new Promise(function(t,r){e(function(e,n){i&&"function"==typeof i&&i(),e?r(e):t(n)})});e(function(e,n){i&&"function"==typeof i&&i(),t(e,n)})}function M(t,e){var n=!0;if(t)for(var r in e){switch(r){case"/and":n=n&&e[r].reduce(function(e,n){return e&&M(t,n)},!0);break;case"/or":n=n&&e[r].reduce(function(e,n){return e||M(t,n)},!1);break;default:var i=e[r];if("object"===f(i))for(var a in i)switch(a){case">":n="number"==typeof t[r]&&"number"==typeof i[a]?n&&t[r]>i[a]:"string"==typeof t[r]&&"string"==typeof i[a]&&(n&&0<t[r].localeCompare(i[a]));break;case">=":n="number"==typeof t[r]&&"number"==typeof i[a]?n&&t[r]>=i[a]:"string"==typeof t[r]&&"string"==typeof i[a]&&(n&&0<=t[r].localeCompare(i[a]));break;case"<":n="number"==typeof t[r]&&"number"==typeof i[a]?n&&t[r]<i[a]:"string"==typeof t[r]&&"string"==typeof i[a]&&(n&&t[r].localeCompare(i[a])<0);break;case"<=":n="number"==typeof t[r]&&"number"==typeof i[a]?n&&t[r]<=i[a]:"string"==typeof t[r]&&"string"==typeof i[a]&&(n&&t[r].localeCompare(i[a])<=0);break;case"=":n=n&&t[r]===i[a];break;case"!=":n=n&&t[r]!==i[a];break;case"/in":n=n&&Array.isArray(i[a])&&0<=i[a].indexOf(t[r]);break;case"/nin":n=n&&Array.isArray(i[a])&&i[a].indexOf(t[r])<0;break;case"/like":n=n&&"string"==typeof i[a]&&"string"==typeof t[r]&&0<=t[r].indexOf(i[a]);break;case"/nlike":n=n&&"string"==typeof i[a]&&"string"==typeof t[r]&&t[r].indexOf(i[a])<0;break;case"/regex":n=n&&i[a]instanceof RegExp&&i[a].test(t[r]);break;case"/where":n=n&&i[a](t[r]);break;default:n=n&&E(t[r],i)}else n=n&&t[r]===i}if(!n)break}else n=!1;return n}var A=1/0,S=function(){function r(e){l(this,r),this.condition=e,this.offset=0,this.limit=A,this.index=null,this.desc=!1}return c(r,null,[{key:"and",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return 0<n.length?new r({"/and":n}):new r({})}},{key:"or",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return 0<n.length?new r({"/or":n}):new r({})}},{key:"Order",get:function(){return{ASC:1,DESC:-1}}}]),c(r,[{key:"match",value:function(e){return M(e,this.condition)}}]),r}(),_=function(){function r(e){l(this,r),this.blockKey=e,this.data=[]}return c(r,[{key:"get",value:function(e){e=this.indexOf(e);return 0<=e?this.data[e].value:null}},{key:"indexOf",value:function(e){for(var n in this.data)if(this.data[n].key===e)return parseInt(n);return-1}},{key:"add",value:function(e,n){var t=this.indexOf(e);t<0?this.data.push({key:e,value:n}):this.data[t]={key:e,value:n}}},{key:"remove",value:function(e){e=this.indexOf(e);return 0<=e&&(this.data.splice(e,1),!0)}},{key:"getSerializedData",value:function(){return JSON.stringify(this.data)}},{key:"count",get:function(){return this.data.length}}],[{key:"createKey",value:function(e,n){n=1<arguments.length&&void 0!==n?n:0;return"".concat(e.toLowerCase(),"-blk-").concat(n)}},{key:"buildFromSerializedData",value:function(e,n){var t=new r(e);try{return t.data=JSON.parse(n),t}catch(e){return null}}}]),r}(),O=function(){function e(){l(this,e),this._queue=[],this.locked=!1}return c(e,[{key:"lock",value:function(e){var n=this;this.locked?this._queue.push(e):(this.locked=!0,e(function(){return n.unlock()}))}},{key:"unlock",value:function(){var e;this.locked=!1,0<this._queue.length&&(e=this._queue.shift(),this.lock(e))}}]),e}();"undefined"==typeof Promise&&(Promise=e);var T="adb-trns-",R={},U=function(){function s(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};l(this,s);var t=k.getInstance();this.name=e,this.initialized=!1,this.queue={},this.batchInterval=n.batchInterval||t.batchInterval,this.batchUpdateTimer=null,this.transactionMutex=new O,this.transactionState=s.State.IDLE,this.transactionCount=0,this.encryption=t.encryption,n.encryption&&n.encryption.hasOwnProperty("encrypt")&&n.encryption.hasOwnProperty("decrypt")&&"function"==typeof n.encryption.encrypt&&"function"==typeof n.encryption.decrypt&&(this.encryption=n.encryption),R[e]=this}return c(s,[{key:"init",value:function(e){var t=this,r=0<arguments.length&&void 0!==e?e:function(){};this.initialized?r(null):(this.initialized=!0,0===Object.keys(this.queue).length?H.Storage.getItem(T+this.name,function(e,n){n?t.encryption.decrypt(n,function(e,n){e||(t.queue=JSON.parse(n)),r(e)}):r(null)}):r(null))}},{key:"flush",value:function(){var a=this;this.transactionMutex.lock(function(r){H.Storage.setItem(T+a.name,JSON.stringify(a.queue),function(e){if(e)throw r(),e;var n,t=[];for(n in a.queue)!function(i){var e=a.queue[i];switch(e.action){case s.Action.SET:t.push(new Promise(function(t,r){a.encryption.encrypt(JSON.stringify(e.data),function(e,n){e?r(e):H.Storage.setItem(i,n).then(t).catch(r)})}));break;case s.Action.REMOVE:t.push(H.Storage.removeItem(i))}}(n);a.batchUpdateTimer=null,Promise.all(t).then(function(){a.queue={},H.Storage.removeItem(T+a.name,function(){r()})}).catch(function(e){throw r(),e})})})}},{key:"startTransaction",value:function(){this.transactionState=s.State.RUNNING,this.transactionCount++}},{key:"endTransaction",value:function(){this.transactionState===s.State.RUNNING&&(this.transactionCount--,0===this.transactionCount&&(this.flush(),this.transactionState=s.State.IDLE))}},{key:"addJob",value:function(e,n,t){var r=this;this.queue[n]={action:e,data:t},this.transactionState===s.State.IDLE&&(this.batchUpdateTimer||(this.batchUpdateTimer=setTimeout(function(){r.transactionState===s.State.IDLE&&r.flush(),r.batchUpdateTimer=null},this.batchInterval)))}},{key:"drop",value:function(){this.batchUpdateTimer&&clearTimeout(this.batchUpdateTimer),this.transactionState=s.State.IDLE,this.transactionMutex.unlock(),this.transactionCount=0,this.queue={}}}],[{key:"dropAll",value:function(){for(var e in R)R[e].drop();R=[]}},{key:"Action",get:function(){return{SET:"set",REMOVE:"remove"}}},{key:"State",get:function(){return{IDLE:"idle",RUNNING:"running"}}}]),s}(),D="adb-info-",N=function(){function r(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};l(this,r);var t=k.getInstance();this.cachedBlockLimit=n.cachedBlockLimit||t.cachedBlockLimit,this.cachedBlockFlush=n.cachedBlockFlush||t.cachedBlockFlush,this.cacheMutex=new O,this.encryption=t.encryption,n.encryption&&n.encryption.hasOwnProperty("encrypt")&&n.encryption.hasOwnProperty("decrypt")&&"function"==typeof n.encryption.encrypt&&"function"==typeof n.encryption.decrypt&&(this.encryption=n.encryption),this.batchSize=n.batchSize||t.batchSize,this.batchQueue=n.sharedBatchQueue||new U(e,n),this.transaction=null,this.name=e,this.info={},this.blockCache={},this.blockCacheCursor=0,this.currentBlock=null}return c(r,[{key:"_findBlockKey",value:function(e){return this.info.blockMap[e]}},{key:"_getBlockFromCache",value:function(e){return this.blockCache[e]?this.blockCache[e].block:null}},{key:"_putBlockToCache",value:function(e){var t=this;this.blockCache[e.blockKey]={seq:this.blockCacheCursor++,block:e};var n=Object.keys(this.blockCache);if(n.length>=this.cachedBlockLimit)for(var r in n.sort(function(e,n){return t.blockCache[e].seq-t.blockCache[n].seq}),n)this._removeBlockFromCache(n[r])}},{key:"_removeBlockFromCache",value:function(e){this.blockCache.hasOwnProperty(e)&&delete this.blockCache[e]}},{key:"_getBlock",value:function(t,r){var i=this,e=this._getBlockFromCache(t);e?r(null,e):H.Storage.getItem(t).then(function(e){e?i.encryption.decrypt(e,function(e,n){e?r(e):(n=_.buildFromSerializedData(t,n),i._putBlockToCache(n),r(null,n))}):r(null)}).catch(function(e){return r(e)})}},{key:"_assignNewBlock",value:function(e){this.info.cursor++;var n=_.createKey(this.name,this.info.cursor),t=new _(n);this._putBlockToCache(t),this.currentBlock=t,e&&e.key&&(t.add(e.key,e.value),this.info.blockMap[e.key]=n,this.info.count++),this.batchQueue.addJob(U.Action.SET,t.blockKey,t.data),this.batchQueue.addJob(U.Action.SET,D+this.name,this.info)}},{key:"init",value:function(e){var r=this,i=0<arguments.length&&void 0!==e?e:function(){};this.batchQueue.init(function(e){e?i(e):H.Storage.getItem(D+r.name,function(e,n){e?i(e):n?r.encryption.decrypt(n,function(e,n){var t;e?i(e):(r.info=JSON.parse(n),t=_.createKey(r.name,r.info.cursor),r._getBlock(t,function(e,n){e||(r.currentBlock=n||new _(t)),i(e,r.info,!1)}))}):(r.info={blockMap:{},cursor:0,count:0},r.info.cursor=-1,r._assignNewBlock(),i(null,r.info,!0))})})}},{key:"startTransaction",value:function(){this.batchQueue.startTransaction()}},{key:"endTransaction",value:function(){this.batchQueue.endTransaction()}},{key:"getItem",value:function(t,e){var r=1<arguments.length&&void 0!==e?e:function(){},e=this._findBlockKey(t);e?this._getBlock(e,function(e,n){!e&&n?r(null,n.get(t)):r(e||new Error("Broken integrity - data not found."))}):r(null,null)}},{key:"setItem",value:function(t,r,e){var i=this,a=2<arguments.length&&void 0!==e?e:function(){},e=this._findBlockKey(t);e?this._getBlock(e,function(e,n){!e&&n?(n.add(t,r),i.batchQueue.addJob(U.Action.SET,n.blockKey,n.data),a(null)):a(e||new Error("Broken integrity - data not found."))}):((e=this.currentBlock)&&e.count<this.batchSize?(e.add(t,r),this.batchQueue.addJob(U.Action.SET,e.blockKey,e.data),this.info.count++,this.info.blockMap[t]=e.blockKey,this.batchQueue.addJob(U.Action.SET,D+this.name,this.info)):this._assignNewBlock({key:t,value:r}),a(null))}},{key:"removeItem",value:function(t,e){var r=this,i=1<arguments.length&&void 0!==e?e:function(){},a=this._findBlockKey(t);a?this._getBlock(a,function(e,n){e?i(e):n?(n.remove(t)&&(r.info.blockMap.hasOwnProperty(t)&&delete r.info.blockMap[t],r.info.count--),0<n.data.length?r.batchQueue.addJob(U.Action.SET,a,n.data):(r._removeBlockFromCache(a),r.batchQueue.addJob(U.Action.REMOVE,a)),r.batchQueue.addJob(U.Action.SET,D+r.name,r.info),i(null)):i(new Error("Failed to remove item - data not found."))}):i(new Error("Failed to remove item - data not found."))}},{key:"clear",value:function(e){for(var e=0<arguments.length&&void 0!==e?e:function(){},n=0;n<=this.info.cursor;n++)this.batchQueue.addJob(U.Action.REMOVE,_.createKey(this.name,n));this.blockCacheCursor=0,this.blockCache={},this.info={blockMap:{},cursor:-1,count:0},this._assignNewBlock(),e(null)}},{key:"drop",value:function(e){var n=this,t=0<arguments.length&&void 0!==e?e:function(){};this.clear(function(){n.batchQueue.addJob(U.Action.REMOVE,D+n.name),t(null)})}},{key:"keys",get:function(){return Object.keys(this.info.blockMap)}},{key:"count",get:function(){return this.info.count}}]),r}();function x(e,n,t){var r=e.offset,i=e.condition,a=e.progress,s=1<arguments.length&&void 0!==n?n:function(e,n){return n(null,!0)},o=2<arguments.length&&void 0!==t?t:function(){},u=r;!function t(){i(u)?b(function(){s(u,function(e,n){e?o(e):n?(u=a(u),t()):o(null)})}):o(null)}()}var F="idx-",P=function(){function i(e){var n,t=e.collection,r=e.columns,r=void 0===r?{}:r,e=e.options,e=void 0===e?{}:e;for(n in l(this,i),this.collection=t,this.columns=r,this.key=i.createKey(this.columns),this.columns)this.columns[n]=1;this.store=new N(t.name+"-index-"+this.key,e),this.table=[]}return c(i,[{key:"columnValues",value:function(n){return this.columnNames.map(function(e){return n?n[e]:null})}},{key:"compareColumnValues",value:function(e,n,t){for(var r=!(2<arguments.length&&void 0!==t)||t,i=this.columnNames,a=0;a<i.length;a++){var s=i[a],o=this.columns[s],s=function(e,n,t){var r=2<arguments.length&&void 0!==t&&t;if(C(e)){if(!C(n))return r?-1:1;if(f(e)===f(n)&&e!==n){t=f(e);if("boolean"===t)return e?1:-1;if("number"===t)return n<e?1:-1;if("string"===t)return e.localeCompare(n);if(e instanceof Date&&n instanceof Date&&e.getTime()!==n.getTime())return e.getTime()>n.getTime()?1:-1}}else if(C(n))return r?1:-1;return 0}(e[a],n[a],r);if(0!==s)return o*s}return 0}},{key:"init",value:function(e){var r=this,i=0<arguments.length&&void 0!==e?e:function(){};this.store.init(function(e,n,t){e?i(e):t?r.save(i):r.store.getItem("".concat(F).concat(r.key),function(e,n){n&&(r.table=n),i(e)})})}},{key:"each",value:function(a,e,n){var t=this,r=1<arguments.length&&void 0!==e?e:null,s=0<(2<arguments.length&&void 0!==n?n:1),n=s?0:this.table.length-1;if(r&&0<this.table.length){for(var i={start:0,end:this.table.length},o=n;i.start<i.end;){var u=this.compareColumnValues(this.table[o].key,r,s);if(0===u)break;0<u?i.end=o-1:i.start=o+1,o=parseInt((i.start+i.end)/2)}n=o}var c=!0;x({offset:n,condition:function(e){return s?e<t.table.length:0<=e},progress:function(e){return s?e+1:e-1}},function(e,n){var r,i,e=t.table[e];e?(r=e.key,i=e.value,x({offset:s?0:i.length-1,condition:function(e){return s?e<i.length:0<=e},progress:function(e){return s?e+1:e-1}},function(e,t){a({key:r,value:i[e]},function(e,n){t(e,c=e||n)})},function(e){return n(e,c)})):n(null,!1)},function(){a(null,function(){})})}},{key:"put",value:function(i,e){var a=this,s=!1,o=this.columnValues(e);x({offset:0,condition:function(e){return e<a.table.length},progress:function(e){return e+1}},function(e,n){var t,r=a.table[e];r?0<(t=a.compareColumnValues(r.key,o))?(a.table.splice(e,0,{key:o,value:[i]}),s=!0,a.save(function(e){return n(e,!1)})):0===t?r.value.indexOf(i)<0?(r.value.push(i),s=!0,a.save(function(e){return n(e,!1)})):n(null,!1):n(null,!0):n(null,!1)},function(){s||(a.table.push({key:o,value:[i]}),a.save())})}},{key:"update",value:function(e,n,t){var r=this.columnValues(n),i=this.columnValues(t);0!==this.compareColumnValues(r,i)&&(this.remove(e,n),this.put(e,t))}},{key:"remove",value:function(i,e){var a=this,s=this.columnValues(e);x({offset:0,condition:function(e){return e<a.table.length},progress:function(e){return e+1}},function(e,n){var t,r=a.table[e];r?0===a.compareColumnValues(r.key,s)?0<=(t=r.value.indexOf(i))?(r.value.splice(t,1),0===r.value.length&&a.table.splice(e,1),a.save(function(e){return n(e,!1)})):n(null,!1):n(null,!0):n(null,!1)},function(){})}},{key:"save",value:function(e){e=0<arguments.length&&void 0!==e?e:function(){};this.store.setItem("".concat(F).concat(this.key),this.table,e)}},{key:"clear",value:function(){this.table=[],this.store.clear()}},{key:"drop",value:function(){this.table=[],this.store.drop()}},{key:"columnNames",get:function(){return Object.keys(this.columns)}}],[{key:"createKey",value:function(n){return Object.keys(n).map(function(e){return"".concat(e,"_").concat(n[e])}).join("__")}}]),i}();"undefined"==typeof Promise&&(Promise=e);var L=new WeakMap,B=new WeakMap,V=function(){function t(e,n){l(this,t),this.name=e,this.pk=n,L.set(this,new N(e)),B.set(this,[])}return c(t,[{key:"init",value:function(e){var t=L.get(this);return w(function(n){t.init(function(e){n(e)})},e)}},{key:"_findProperIndexer",value:function(e){if(e.index)for(var n=B.get(this),t=0;t<n.length;t++)if(E(n[t].columns,e.index))return n[t];return null}},{key:"_addItemToIndex",value:function(e,n){for(var t=B.get(this),r=0;r<t.length;r++)t[r].put(e,n)}},{key:"_updateItemToIndex",value:function(e,n,t){for(var r=B.get(this),i=0;i<r.length;i++)r[i].update(e,n,t)}},{key:"_removeItemFromIndex",value:function(e,n){for(var t=B.get(this),r=0;r<t.length;r++)t[r].remove(e,n)}},{key:"ensureIndex",value:function(n,e){var t=this,o=L.get(this),r=B.get(this),i=P.createKey(n);return w(function(a){for(var e=0;e<r.length;e++)if(i===r[e].key)return void a(null);var s=new P({collection:t,columns:n,options:{sharedBatchQueue:o.batchQueue}});s.init(function(e,n,t){e?a(e):(r.push(s),t?function(){for(var r=o.keys,i=0,e=0;e<r.length;e++)!function(e){var t=r[e];o.getItem(t,function(e,n){!e&&n?s.put(t,n,function(){++i===r.length&&a(null)}):++i===r.length&&a(null)})}(e)}():a(null))})},e)}},{key:"removeIndex",value:function(e,n){var r=B.get(this),i=P.createKey(e);return w(function(t){for(var e=0;e<r.length;e++){var n=function(n){if(i===r[n].key)return r[n].drop(function(e){e||r.splice(n,1),t(e)}),{v:void 0}}(e);if("object"===f(n))return n.v}t(null)},n)}},{key:"findById",value:function(e,n){var r=L.get(this);return w(function(t){e?("string"!=typeof e&&(e=JSON.stringify(e)),r.getItem(e,function(e,n){t(e,n)})):t(new Error("Invalid type: 'id' should not be empty."))},n)}},{key:"findOne",value:function(e,t){return e.limit=1,this.find(e,function(e,n){t(e,0<n.length?n[0]:null)})}},{key:"find",value:function(c,e){var l=this,h=L.get(this);return w(function(n){if(c instanceof S){var r=[],e=l._findProperIndexer(c);if(e){for(var i=[],t=0;t<e.columnNames.length;t++){var a=e.columnNames[t];if(!c.condition[a])break;if("object"===f(c.condition[a])){if("break"===function(){var e=Object.keys(c.condition[a]),n=["="],t=e.filter(function(e){return n.includes(e)});if(!(0<t.length))return"break";t=e.indexOf(t[0]);i.push(c.condition[a][e[t]])}())break}else{if("function"==typeof c.condition[a]||void 0===c.condition[a]||Array.isArray(c.condition[a]))break;i.push(c.condition[a])}}var s=c.offset||0;e.each(function(e,t){e?h.getItem(e.value,function(e,n){e?t(e):(c.match(n)&&(s<=0?r.push(n):s--),t(null,r.length<c.limit))}):n(null,r)},0<i.length?i:null,c.desc?S.Order.DESC:S.Order.ASC)}else{var o=!c.desc,u=h.keys;x({offset:c.offset<u.length?o?c.offset:u.length-c.offset-1:o?u.length:-1,condition:function(e){return o?r.length<c.limit&&e<u.length:r.length<c.limit&&0<=e},progress:function(e){return o?e+1:e-1}},function(e,t){h.getItem(u[e],function(e,n){e?t(e):(c.match(n)&&r.push(n),b(function(){return t(null,!0)}))})},function(e){n(e,r)})}}else n(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"count",value:function(a,e){var s=L.get(this);return w(function(n){var r,i;!a||a instanceof S?a?(r=s.keys,x({offset:i=0,condition:function(e){return e<r.length},progress:function(e){return e+1}},function(e,t){s.getItem(r[e],function(e,n){e?t(e):(a.match(n)&&i++,b(function(){return t(null,!0)}))})},function(e){n(e,i)})):n(null,s.count):n(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"insert",value:function(i,e){var a=this,s=L.get(this);return s.startTransaction(),w(function(t){if(Array.isArray(i)){for(var e=[],n=0;n<i.length;n++)i[n]&&"object"===f(i[n])&&e.push(a.insert(i[n]));i.length===e.length?Promise.all(e).then(function(){return t(null,i)}).catch(function(e){return t(e)}):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else{var r;i&&"object"===f(i)?i[a.pk]?(r="".concat(i[a.pk]),s.getItem(r,function(e,n){e?t(e):n?t(new Error("Duplicated item: item already exists.")):(a._addItemToIndex(r,i),s.setItem(r,i,function(e){t(e,i)}))})):t(new Error("Invalid key: item should have key.")):t(new Error("Invalid type: 'item' should be an object or an object array."))}},e,function(){return s.endTransaction()})}},{key:"upsert",value:function(i,e){var a=this,s=L.get(this);return s.startTransaction(),w(function(t){if(Array.isArray(i)){for(var e=[],n=0;n<i.length;n++)i[n]&&"object"===f(i[n])&&e.push(a.upsert(i[n]));i.length===e.length?Promise.all(e).then(function(){return t(null,i)}).catch(function(e){return t(e)}):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else{var r;i&&"object"===f(i)?i[a.pk]?(r="".concat(i[a.pk]),s.getItem(r,function(e,n){e?t(e):(n?a._updateItemToIndex(r,n,i):a._addItemToIndex(r,i),s.setItem(r,i,function(e){t(e,i)}))})):t(new Error("Invalid key: item should have key.")):t(new Error("Invalid type: 'item' should be an object or an object array."))}},e,function(){return s.endTransaction()})}},{key:"update",value:function(i,e){var a=this,s=L.get(this);return s.startTransaction(),w(function(t){if(Array.isArray(i)){for(var e=[],n=0;n<i.length;n++)i[n]&&"object"===f(i[n])&&e.push(a.update(i[n]));i.length===e.length?Promise.all(e).then(function(){return t(null,i)}).catch(function(e){return t(e)}):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else{var r;i&&"object"===f(i)?i[a.pk]?(r="".concat(i[a.pk]),s.getItem(r,function(e,n){e?t(e):n?(a._updateItemToIndex(r,n,i),s.setItem(r,i,function(e){t(e,i)})):t(null)})):t(new Error("Invalid key: item should have key.")):t(new Error("Invalid type: 'item' should be an object or an object array."))}},e,function(){return s.endTransaction()})}},{key:"updateIf",value:function(u,c,e){var l=this,h=L.get(this);return h.startTransaction(),w(function(n){var o,t;u instanceof S?(o=[],t=h.keys,x({offset:0,condition:function(e){return e<t.length},progress:function(e){return e+1}},function(e,s){h.getItem(t[e],function(e,n){if(e)s(e);else if(n&&u.match(n)){var t,r=JSON.parse(JSON.stringify(n)),i=!1;for(t in c){var a=c[t];E(n[t],a)||(i=!0,n[t]=a)}i?(e="".concat(n[l.pk]),l._updateItemToIndex(e,r,n),h.setItem(e,n,function(e){e?s(e):(o.push(n),b(function(){return s(null,!0)}))})):b(function(){return s(null,!0)})}else b(function(){return s(null,!0)})})},function(e){n(e,o)})):n(new Error("Invalid type: 'query' should be Query type."))},e,function(){return h.endTransaction()})}},{key:"remove",value:function(r,e){var i=this,a=L.get(this);return a.startTransaction(),w(function(t){r?(r="".concat(r),a.getItem(r,function(e,n){e?t(e):n?(i._removeItemFromIndex(r,n),a.removeItem(r,function(e){t(e)})):t(null)})):t(new Error("Invalid type: 'id' should be string type."))},e,function(){return a.endTransaction()})}},{key:"removeIf",value:function(a,e){var s=this,o=L.get(this);return o.startTransaction(),w(function(n){var r,i;a instanceof S?(r=[],i=o.keys,x({offset:0,condition:function(e){return e<i.length},progress:function(e){return e+1}},function(e,t){o.getItem(i[e],function(e,n){e?t(e):n&&a.match(n)?(e="".concat(n[s.pk]),s._removeItemFromIndex(e,n),o.removeItem(e,function(e){e?t(e):(r.push(n),b(function(){return t(null,!0)}))})):b(function(){return t(null,!0)})})},function(e){n(e,r)})):n(new Error("Invalid type: 'query' should be Query type."))},e,function(){return o.endTransaction()})}},{key:"clear",value:function(e){var t=B.get(this),r=L.get(this);return r.startTransaction(),w(function(n){for(var e=0;e<t.length;e++)t[e].clear();r.clear(function(e){n(e)})},e,function(){return r.endTransaction()})}}]),t}();"undefined"==typeof Promise&&(Promise=e);var j=null,G=new WeakMap,Q=new WeakMap,H=function(){function t(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};l(this,t),this.name=e,this.config=new k(n),G.set(this,{}),Q.set(this,{})}return c(t,null,[{key:"Query",get:function(){return S}},{key:"Storage",get:function(){return j},set:function(e){j=e}}]),c(t,[{key:"schema",value:function(e,n){var t=G.get(this);return t[e]=n,this}},{key:"build",value:function(){var s=G.get(this),o=Q.get(this);return new Promise(function(i,a){var e,n,t=[];for(e in s)o[e]||(n=s[e].key||"_id",n=o[e]=new V(e,n),t.push(n.init()));Promise.all(t).then(function(){var e,n=[];for(e in o)if(s[e].index&&0<s[e].index.length){var t,r=o[e];for(t in s[e].index)n.push(r.ensureIndex(s[e].index[t]))}0<n.length?Promise.all(n).then(function(){i()}).catch(function(e){return a(e)}):i()}).catch(function(e){return a(e)})})}},{key:"close",value:function(){}},{key:"drop",value:function(){var e,n=this,t=[],r=Q.get(this);for(e in r)t.push(r[e].clear());U.dropAll(),Promise.all(t).then(function(){G.set(n,{}),Q.set(n,{})}).catch(function(){})}},{key:"collection",value:function(e){var n=Q.get(this);return n[e]&&n[e]instanceof V?n[e]:null}}]),t}();"undefined"==typeof Promise&&(Promise=e);function K(){var e=!!document.documentMode,n=!e&&!!window.StyleMedia;return!e&&!n}function W(n,t){var e=f(n),r=f(t);return!n||!t||"object"!==e||e!==r||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===e&&"function"===r||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(e){return W(n[e],t[e])})}function z(e){var n=null;return e&&(Array.isArray(e)?n=K()?e.join("_"):e[e.length-1]:"object"===f(e)?n=z(Object.keys(e)):"string"==typeof e&&(n=e)),n}function J(e,n,i){if(!n)return new Promise(function(t,r){e(function(e,n){i&&"function"==typeof i&&i(),e?r(e):t(n)})});e(n)}function X(){if("undefined"==typeof document&&"undefined"!=typeof navigator&&"ReactNative"==navigator.product)return Promise.resolve(!1);var r=window?window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB:null,i="undefined"!=typeof InstallTrigger||window._isTestingFirefox,a=!!!document.documentMode&&!!window.StyleMedia;return new Promise(function(e,n){try{if(i){if(!r)return void e(!0);var t=r.open("_testMozilla");t.onerror=function(){e(!0)},t.onsuccess=function(){e(!1)}}else!a||window.indexedDB||!window.PointerEvent&&!window.MSPointerEvent?e(!1):e(!0)}catch(e){n(e)}})}function Y(e){return"object"===f(e)&&e}function $(t,e){var n,r=!0;for(n in e){switch(n){case"/and":r=r&&e[n].reduce(function(e,n){return e&&$(t,n)},!0);break;case"/or":r=r&&e[n].reduce(function(e,n){return e||$(t,n)},!1);break;default:var i=e[n];if("object"===f(i))for(var a in i)switch(a){case">":r="number"==typeof t[n]&&"number"==typeof i[a]?r&&t[n]>i[a]:"string"==typeof t[n]&&"string"==typeof i[a]&&(r&&0<t[n].localeCompare(i[a]));break;case">=":r="number"==typeof t[n]&&"number"==typeof i[a]?r&&t[n]>=i[a]:"string"==typeof t[n]&&"string"==typeof i[a]&&(r&&0<=t[n].localeCompare(i[a]));break;case"<":r="number"==typeof t[n]&&"number"==typeof i[a]?r&&t[n]<i[a]:"string"==typeof t[n]&&"string"==typeof i[a]&&(r&&t[n].localeCompare(i[a])<0);break;case"<=":r="number"==typeof t[n]&&"number"==typeof i[a]?r&&t[n]<=i[a]:"string"==typeof t[n]&&"string"==typeof i[a]&&(r&&t[n].localeCompare(i[a])<=0);break;case"=":r=r&&t[n]===i[a];break;case"!=":r=r&&t[n]!==i[a];break;case"/in":r=r&&Array.isArray(i[a])&&0<=i[a].indexOf(t[n]);break;case"/nin":r=r&&Array.isArray(i[a])&&i[a].indexOf(t[n])<0;break;case"/like":r=r&&"string"==typeof i[a]&&"string"==typeof t[n]&&0<=t[n].indexOf(i[a]);break;case"/nlike":r=r&&"string"==typeof i[a]&&"string"==typeof t[n]&&t[n].indexOf(i[a])<0;break;case"/regex":r=r&&i[a]instanceof RegExp&&i[a].test(t[n]);break;case"/where":r=r&&i[a](t[n]);break;default:r=r&&W(t[n],i)}else r=r&&t[n]===i}if(!r)break}return r}var Z=function(){function e(){l(this,e),this._field={}}return c(e,[{key:"has",value:function(e){if(Y(e))return e.__wk&&"string"==typeof e.__wk&&this._field.hasOwnProperty(e.__wk);throw new Error("Invalid value used as weak map key")}},{key:"get",value:function(e){if(Y(e))return e.__wk&&"string"==typeof e.__wk?this._field[e.__wk]:null;throw new Error("Invalid value used as weak map key")}},{key:"set",value:function(e,n){if(!Y(e))throw new Error("Invalid value used as weak map key");e.__wk&&"string"==typeof e.__wk||(e.__wk="__".concat((new Date).getTime(),"-").concat(parseInt(1e8*Math.random()))),this._field[e.__wk]=n}},{key:"delete",value:function(e){if(!Y(e))throw new Error("Invalid value used as weak map key");this.has(e)&&delete this._field[e.__wk]}},{key:"length",get:function(){return 0}}]),e}(),Z=function(){try{return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent&&-1<navigator.userAgent.indexOf("MSIE 10")}catch(e){return}}()||function(){try{return document&&9===document.documentMode}catch(e){return}}()||function(){try{return document&&document.documentMode<=8}catch(e){return}}()||"undefined"==typeof window&&"undefined"!=typeof process?Z:WeakMap,ee=new Z,ne=function(){function r(e,n,t){l(this,r),this.name=n,this.keyPath=t,ee.set(this,e)}return c(r,[{key:"findById",value:function(t,e){var r=this,i=ee.get(this);return J(function(e){var n=i.transaction(r.name,"readonly").objectStore(r.name).get(t);n.onsuccess=function(){return e(null,n.result||null)},n.onerror=function(){return e(n.error)}},e)}},{key:"find",value:function(s,e){var o=this,u=ee.get(this);return J(function(t){var e,r,n,i,a;s instanceof ue.Query?(e=z(s.index),r=[],n=u.transaction(o.name,"readonly").objectStore(o.name),i=e?n.index(e).openCursor(null,s.desc?"prev":"next"):n.openCursor(),a=s.offset,i.onsuccess=function(e){var n=e.target.result;n?(e=n.value,s.match(e)?!a||a<0?(r.push(e),r.length<s.limit?n.continue():t(null,r)):(a--,n.continue()):n.continue()):t(null,r)},i.onerror=function(){t(i.error)}):t(new Error("Invalid type: 'query' should be LocalDB.Query type."))},e)}},{key:"count",value:function(a,e){var s=this,o=ee.get(this);return J(function(n){var e,t,r,i;!a||a instanceof ue.Query?(e=o.transaction(s.name,"readonly").objectStore(s.name),a?(t=0,(r=e.openCursor()).onsuccess=function(){var e=r.result;e?(a.match(e.value)&&t++,e.continue()):n(null,t)},r.onerror=function(){n(r.error)}):((i=e.count()).onsuccess=function(){return n(null,i.result)},i.onerror=function(){return n(i.error)})):n(new Error("Invalid type: 'query' should be LocalDB.Query type."))},e)}},{key:"insert",value:function(s,e){var n=this,t=ee.get(this);return J(function(i){var e,a=t.transaction(n.name,"readwrite").objectStore(n.name);Array.isArray(s)?function(){var e,r=[];for(e in s)!function(e){var n=s[e],t=a.add(n);t.onsuccess=function(){r.push(n),r.length===s.length&&i(null,r)},t.onerror=function(){i(t.error)}}(e)}():s&&"object"===f(s)?((e=a.add(s)).onsuccess=function(){return i(null,s)},e.onerror=function(){return i(e.error)}):i(new Error("Invalid type: 'item' should be an object or an object array."))},e)}},{key:"upsert",value:function(a,e){var n=this,s=ee.get(this);return J(function(t){var r,i=s.transaction(n.name,"readwrite").objectStore(n.name);a&&"object"===f(a)?((r=i.get(a[n.keyPath])).onsuccess=function(){var e,n;r.result?((e=i.put(a)).onsuccess=function(){return t(null,a)},e.onerror=function(){return t(e.error)}):((n=i.add(a)).onsuccess=function(){return t(null,a)},n.onerror=function(){return t(n.error)})},r.onerror=function(){t(r.error)}):t(new Error("Invalid type: 'item' should be an object or an object array."))},e)}},{key:"update",value:function(t,e){var r=this,i=ee.get(this);return J(function(e){var n=i.transaction(r.name,"readwrite").objectStore(r.name).put(t);n.onsuccess=function(){return e(null,t)},n.onerror=function(){return e(n.error)}},e)}},{key:"updateIf",value:function(l,h,e){var n=this,t=ee.get(this);return J(function(o){var u,c,e;l instanceof ue.Query?(u=[],c=t.transaction(n.name,"readwrite").objectStore(n.name),(e=c.openCursor()).onsuccess=function(e){var n=e.target.result;if(n){var t=n.value;if(l.match(t)){var r,i,a=!1;for(r in h){var s=h[r];W(t[r],s)||(a=!0,t[r]=s)}a?((i=c.put(t)).onsuccess=function(){u.push(t),n.continue()},i.onerror=function(){o(i.error)}):n.continue()}else n.continue()}else o(null,u)},e.onerror=function(){o(e.error)}):o(new Error("Invalid type: 'query' should be LocalDB.Query type."))},e)}},{key:"remove",value:function(t,e){var r=this,i=ee.get(this);return J(function(e){var n=i.transaction(r.name,"readwrite").objectStore(r.name).delete(t);n.onsuccess=function(){return e(null)},n.onerror=function(){return e(n.error)}},e)}},{key:"removeIf",value:function(o,e){var u=this,n=ee.get(this);return J(function(i){var a,s,e;o instanceof ue.Query?(a=[],s=n.transaction(u.name,"readwrite").objectStore(u.name),(e=s.openCursor()).onsuccess=function(e){var n,t,r=e.target.result;r?(n=r.value,o.match(n)?((t=s.delete(n[u.keyPath])).onsuccess=function(){a.push(n),r.continue()},t.onerror=function(){i(t.error)}):r.continue()):i(null,a)},e.onerror=function(){i(e.error)}):i(new Error("Invalid type: 'query' should be LocalDB.Query type."))},e)}},{key:"clear",value:function(e){var t=this,r=ee.get(this);return J(function(e){var n=r.transaction(t.name,"readwrite").objectStore(t.name).clear();n.onsuccess=function(){return e(null)},n.onerror=function(){return e(n.error)}},e)}}]),r}(),te=1/0,re=function(){function r(e){l(this,r),this.condition=e,this.offset=0,this.limit=te,this.index=null,this.desc=!1}return c(r,null,[{key:"and",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return 0<n.length?new r({"/and":n}):new r({})}},{key:"or",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return 0<n.length?new r({"/or":n}):new r({})}},{key:"Order",get:function(){return{ASC:1,DESC:-1}}}]),c(r,[{key:"match",value:function(e){return $(e,this.condition)}}]),r}();"undefined"==typeof Promise&&(Promise=e);var ie=new Z,ae=new Z,se=new Z,oe=window?window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB:null,ue=function(){function t(e,n){if(l(this,t),!oe)throw new Error("IndexedDB is not supported in this environment. Check if you're in web browser which supports IndexedDB.");this.name=e,this.version=n,ie.set(this,{}),ae.set(this,null),se.set(this,{})}return c(t,null,[{key:"Query",get:function(){return re}}]),c(t,[{key:"schema",value:function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},t=ie.get(this);return t[e]=n,this}},{key:"build",value:function(){var k=this,I=ie.get(this),b=se.get(this);return new Promise(function(i,n){var e=oe.open(k.name,k.version);e.onerror=function(e){n(new Error("IndexedDB is not available: ".concat(e.target.errorCode)))},e.onupgradeneeded=function(e){var n,t=e.target.result,r=e.target.transaction,i=t.objectStoreNames;for(n in I){var a=I[n].key||"id",s=null;try{s=r.objectStore(n)}catch(e){"NotFoundError"===e.name&&(s=t.createObjectStore(n,{keyPath:a}))}if(s){for(var o=[],u=0;u<s.indexNames.length;u++)o.push(s.indexNames[u]);a=new ne(t,n,a);if(I[n].index&&0<I[n].index.length)for(var c in I[n].index){var l=z(I[n].index[c]);if(l){var h,f,d=!1;for(h in o)if(o[h]===l){d=!0;break}d||(f=Object.keys(I[n].index[c]),s.createIndex(l,K()?f:f[f.length-1],{unique:!1}),o.push(l))}}var g=[];if(I[n].index)for(var v in I[n].index){var y=z(I[n].index[v]);y&&g.push(y)}for(var m=0;m<o.length;m++)g.indexOf(o[m])<0&&s.deleteIndex(o[m]);b[n]=a}}for(var p=0;p<i.length;p++)Object.keys(I).indexOf(i.item(p))<0&&t.deleteObjectStore(i.item(p));ae.set(k,t)},e.onsuccess=function(e){var n,t,r=e.target.result;for(n in I)b[n]||(t=I[n].key||"id",b[n]=new ne(r,n,t));ae.set(k,r),i()}})}},{key:"close",value:function(){var e=ae.get(this);e&&(e.close(),ae.set(this,null))}},{key:"drop",value:function(){oe.deleteDatabase(this.name)}},{key:"collection",value:function(e){var n=se.get(this);return n[e]&&n[e]instanceof ne?n[e]:null}}]),t}();function ce(n,t){var e=f(n),r=f(t);return!n||!t||"object"!==e||e!==r||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===e&&"function"===r||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(e){return ce(n[e],t[e])})}function le(e,t,i){if(!t)return new Promise(function(t,r){e(function(e,n){i&&"function"==typeof i&&i(),e?r(e):t(n)})});e(function(e,n){i&&"function"==typeof i&&i(),t(e,n)})}"undefined"==typeof Promise&&(Promise=e);function he(t,e){var n,r=!0;for(n in e){switch(n){case"/and":r=r&&e[n].reduce(function(e,n){return e&&he(t,n)},!0);break;case"/or":r=r&&e[n].reduce(function(e,n){return e||he(t,n)},!1);break;default:var i=e[n];if("object"===f(i))for(var a in i)switch(a){case">":r="number"==typeof t[n]&&"number"==typeof i[a]?r&&t[n]>i[a]:"string"==typeof t[n]&&"string"==typeof i[a]&&(r&&0<t[n].localeCompare(i[a]));break;case">=":r="number"==typeof t[n]&&"number"==typeof i[a]?r&&t[n]>=i[a]:"string"==typeof t[n]&&"string"==typeof i[a]&&(r&&0<=t[n].localeCompare(i[a]));break;case"<":r="number"==typeof t[n]&&"number"==typeof i[a]?r&&t[n]<i[a]:"string"==typeof t[n]&&"string"==typeof i[a]&&(r&&t[n].localeCompare(i[a])<0);break;case"<=":r="number"==typeof t[n]&&"number"==typeof i[a]?r&&t[n]<=i[a]:"string"==typeof t[n]&&"string"==typeof i[a]&&(r&&t[n].localeCompare(i[a])<=0);break;case"=":r=r&&t[n]===i[a];break;case"!=":r=r&&t[n]!==i[a];break;case"/in":r=r&&Array.isArray(i[a])&&0<=i[a].indexOf(t[n]);break;case"/nin":r=r&&Array.isArray(i[a])&&i[a].indexOf(t[n])<0;break;case"/like":r=r&&"string"==typeof i[a]&&"string"==typeof t[n]&&0<=t[n].indexOf(i[a]);break;case"/nlike":r=r&&"string"==typeof i[a]&&"string"==typeof t[n]&&t[n].indexOf(i[a])<0;break;case"/regex":r=r&&i[a]instanceof RegExp&&i[a].test(t[n]);break;case"/where":r=r&&i[a](t[n]);break;default:r=r&&ce(t[n],i)}else r=r&&t[n]===i}if(!r)break}return r}var fe=1/0,de=function(){function r(e){l(this,r),this.condition=e,this.offset=0,this.limit=fe,this.index=null,this.desc=!1}return c(r,null,[{key:"and",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return 0<n.length?new r({"/and":n}):new r({})}},{key:"or",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return 0<n.length?new r({"/or":n}):new r({})}},{key:"Order",get:function(){return{ASC:1,DESC:-1}}}]),c(r,[{key:"match",value:function(e){return he(e,this.condition)}}]),r}();"undefined"==typeof Promise&&(Promise=e);var ge=null,ve=function(){function e(){if(l(this,e),ge)return ge;(ge=this).queries=[],this.executing=!1,this.intervalID=null}return c(e,[{key:"addTask",value:function(t,r){var i=this;return new Promise(function(e,n){i.queries.push({task:t,cb:r,resolve:e,reject:n}),i._delay(),i.executeTask()})}},{key:"executeTask",value:function(){var e=this;if(0<this.queries.length&&!this.executing){this.executing=!0;var n=this.queries[0].task,t=this.queries[0].cb,r=this.queries[0];return new Promise(function(t,r){n(function(e,n){e?r(e):t(n)})}).then(function(e){r.resolve(e),t&&t(null,e)}).catch(function(e){r.reject(e),t&&t(e)}).finally(function(){e._executeNext()})}return Promise.resolve(!0)}},{key:"_delay",value:function(){}},{key:"_executeNext",value:function(){var t=this;if(this.executing=!1,0<this.queries.length)return this.queries=this.queries.slice(1),new Promise(function(e,n){t._delay(),e(t.executeTask())})}},{key:"start",value:function(){}},{key:"stop",value:function(){}}],[{key:"getInstance",value:function(){return new e}}]),e}();"undefined"==typeof Promise&&(Promise=e);var ye=function(){function t(e,n){l(this,t),this.name=e,this.pk=n,this.store={},this.columns=[],this.queue=ve.getInstance(),this.queue.start()}return c(t,[{key:"findById",value:function(n,e){var t=this;return this.queue.addTask(function(e){n?("string"!=typeof n&&(n=JSON.stringify(n)),t.store.hasOwnProperty(n)?e(null,t.store[n]):e(null,null)):e(new Error("Invalid type: 'id' should not be empty."))},e)}},{key:"findOne",value:function(e,n){return e.limit=1,this.find(e,n)}},{key:"find",value:function(s,e){var o=this;return this.queue.addTask(function(e){if(s instanceof de){var n,t=[],r=Object.keys(o.store).map(function(e){return o.store[e]});for(n in r){var i=r[n];s.match(i)&&t.push(i)}s.index&&"Message"!==o.name&&t.sort(function(e,n){for(var t in s.index){if(e[t]>n[t])return s.index[t];if(e[t]<n[t])return-1*s.index[t]}return 0}),s.desc&&t.reverse();var a=s.offset||0;e(null,0<=s.limit&&t.length>=s.limit?t.slice(a,s.limit+a):t.slice(a))}else e(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"count",value:function(a,e){var s=this;return this.queue.addTask(function(e){if(!a||a instanceof de)if(a){var n,t=0,r=a.offset||0;for(n in s.store){if(t>=a.limit)break;var i=s.store[n];a.match(i)&&(r<=0?t+=1:r--)}e(null,t)}else e(null,Object.keys(s.store).length);else e(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"_insertSingle",value:function(t,e){var r=this;return le(function(e){var n;t[r.pk]?(n="".concat(t[r.pk]),r.store.hasOwnProperty(n)?e(new Error("Duplicated item: item already exists.")):e(null,r.store[n]=t)):e(new Error("Invalid key: item should have key."))},e)}},{key:"insert",value:function(r,e){var i=this;return this.queue.addTask(function(t){if(Array.isArray(r)){for(var e=[],n=0;n<r.length;n++)r[n]&&"object"===f(r[n])&&e.push(i._insertSingle(r[n]));r.length===e.length?Promise.all(e).then(function(){t(null,r)}).catch(function(e){t(e)}):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else r&&"object"===f(r)?i._insertSingle(r,function(e,n){t(e,n)}):t(new Error("Invalid type: 'item' should be an object or an object array."))},e)}},{key:"_upsertSingle",value:function(t,e){var r=this;return le(function(e){var n;t[r.pk]?(n="".concat(t[r.pk]),e(null,r.store[n]=t)):e(new Error("Invalid key: item should have key."))},e)}},{key:"upsert",value:function(r,e){var i=this;return this.queue.addTask(function(t){if(Array.isArray(r)){for(var e=[],n=0;n<r.length;n++)r[n]&&"object"===f(r[n])&&e.push(i._upsertSingle(r[n]));r.length===e.length?Promise.all(e).then(function(){t(null,r)}).catch(function(e){t(e)}):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else r&&"object"===f(r)?i._upsertSingle(r,function(e,n){t(e,n)}):t(new Error("Invalid type: 'item' should be an object or an object array."))},e)}},{key:"_updateSingle",value:function(t,e){var r=this;return le(function(e){var n;t[r.pk]?(n="".concat(t[r.pk]),r.store.hasOwnProperty(n)?e(null,r.store[n]=t):e(new Error("Invalid key: no item with such key was found"))):e(new Error("Invalid key: item should have key."))},e)}},{key:"update",value:function(r,e){var i=this;return this.queue.addTask(function(t){if(Array.isArray(r)){for(var e=[],n=0;n<r.length;n++)r[n]&&"object"===f(r[n])&&e.push(i._updateSingle(r[n]));r.length===e.length?Promise.all(e).then(function(){t(null,r)}).catch(function(e){t(e)}):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else r&&"object"===f(r)?i._updateSingle(r,function(e,n){t(e,n)}):t(new Error("Invalid type: 'item' should be an object or an object array."))},e)}},{key:"updateIf",value:function(s,o,e){var u=this;return this.queue.addTask(function(e){if(s instanceof de){var n,t=[];for(n in u.store){var r=u.store[n];if(s.match(r))for(var i in o){var a=o[i];ce(r[i],a)||(r[i]=a,t.push(r))}}e(null,t)}else e(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"remove",value:function(n,e){var t=this;return this.queue.addTask(function(e){n?(n="".concat(n),t.store.hasOwnProperty(n)?(delete t.store[n],e(null)):e(new Error("Invalid key: no item with such key was found"))):e(new Error("Invalid type: 'id' should be string type."))},e)}},{key:"removeIf",value:function(i,e){var a=this;return this.queue.addTask(function(e){if(i instanceof de){var n,t=[];for(n in a.store){var r=a.store[n];i.match(r)&&(t.push(r),delete a.store[n])}e(null,t)}else e(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"clear",value:function(e){var n=this;return this.queue.addTask(function(e){n.store={},e(null)},e)}}]),t}();"undefined"==typeof Promise&&(Promise=e);var me=new Z,pe=new Z,ke=function(){function t(e,n){l(this,t),this.name=e,this.version=n,me.set(this,{}),pe.set(this,{}),ve.getInstance().start()}return c(t,null,[{key:"Query",get:function(){return de}}]),c(t,[{key:"schema",value:function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},t=me.get(this);return t[e]=n,this}},{key:"build",value:function(){var i=me.get(this),a=pe.get(this);return new Promise(function(e,n){for(var t in i){var r;a[t]||(r=i[t].key||"_id",a[t]=new ye(t,r))}e()})}},{key:"close",value:function(){}},{key:"drop",value:function(){me.set(this,{});var e,n=pe.get(this);for(e in n)n[e].clear();pe.set(this,{})}},{key:"collection",value:function(e){var n=pe.get(this);return n[e]&&n[e]instanceof ye?n[e]:null}}]),t}();"undefined"==typeof Promise&&(Promise=e);var Ie=null,be=!1,Ee=function(){function e(){l(this,e)}return c(e,null,[{key:"init",value:function(){Ie=Ie||(window?window.localStorage:null)}},{key:"useReactNative",value:function(e){Ie=e,be=!0}},{key:"getKeys",value:function(){return be?Ie.getAllKeys():new Promise(function(e){var n,t=[];for(n in Ie)t.push(n);e(t)})}},{key:"get",value:function(t){return be?Ie.getItem(t):new Promise(function(e){var n=Ie.getItem(t);e(void 0!==n?n:null)})}},{key:"set",value:function(n,t){return be?Ie.setItem(n,t):new Promise(function(e){Ie.setItem(n,t),e()})}},{key:"remove",value:function(n){return be?Ie.removeItem(n):new Promise(function(e){Ie.removeItem(n),e()})}},{key:"clear",value:function(){return be?Ie.clear():new Promise(function(e){Ie.clear(),e()})}}]),e}(),Ce=98765,we={NONE:0,ERROR:1,WARNING:2,INFO:3},Me=we.NONE,Ae="",Se=function(){function r(){l(this,r)}return c(r,null,[{key:"isValidLevel",value:function(e){return-1<Object.keys(we).map(function(e){return we[e]}).indexOf(e)}},{key:"_permit",value:function(e,n){if(e<=Me){var t="";switch(e){case we.ERROR:t="error";break;case we.WARNING:t="warning";break;case we.INFO:case Ce:t="log";break;default:t=""}if(console&&console[t]){for(var r,n="".concat(Ae," ").concat(n||""," "),i=arguments.length,a=new Array(2<i?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];"string"==typeof a[0]?(a[0]=n+a[0],(r=console)[t].apply(r,a)):(r=console)[t].apply(r,[n].concat(a))}}}},{key:"error",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[we.ERROR,"[ERROR]"].concat(n))}},{key:"warning",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[we.WARNING,"[WARNING]"].concat(n))}},{key:"info",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[we.INFO,"[INFO]"].concat(n))}},{key:"call",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[Ce,"[CALL]"].concat(n))}},{key:"event",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[Ce,"[EVENT]"].concat(n))}},{key:"view",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[Ce,"[VIEW]"].concat(n))}},{key:"message",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[Ce,"[MESSAGE]"].concat(n))}},{key:"cache",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[Ce,"[CACHE]"].concat(n))}},{key:"sync",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[Ce,"[SYNC]"].concat(n))}},{key:"level",set:function(e){var n=Object.keys(we).map(function(e){return we[e]});n.push(Ce),-1<n.indexOf(e)&&(Me=e)},get:function(){return Me}},{key:"prefix",set:function(e){"string"==typeof e&&(Ae=e)}}]),r}(),_e=function(){!function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&o(e,n)}(a,n(Error));var t,r,i=(t=a,r=u(),function(){var e,n=s(t);return h(this,r?(e=s(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))});function a(e,n){return l(this,a),(e=i.call(this,e)).name="SyncManagerException",e.code=n||0,e}return c(a,null,[{key:"create",value:function(e){e=0<arguments.length&&void 0!==e?e:a.Type.ERROR_UNKNOWN;return new a(e.message,e.code)}},{key:"throw",value:function(e){Se.error(e)}},{key:"Type",get:function(){return{ERROR_UNKNOWN:{code:81e4,message:"Unknown error occurred."},ERROR_DATABASE_IO:{code:810001,message:"Database I/O operation failed."},ERROR_SETUP_MISSING:{code:810100,message:"SendBirdSyncManager.setup() is not called."},ERROR_SENDBIRD_MISSING:{code:810101,message:"SendBird instance should be set before init()."},ERROR_DUPLICATED_FETCH:{code:810200,message:"Fetch is in progress."},ERROR_DUPLICATED_CHANGELOG_SYNC:{code:810210,message:"Sync is in progress."},ERROR_INVALID_PARAMETER:{code:810300,message:"Invalid parameter."}}}}]),a}(),Oe=function(o,n){function i(n,r){c.lock(function(t){var e=jn.getInstance();e.currentUserId?(n.ownerUserId=e.currentUserId,n.lastMessageUpdatedAt=(n.lastMessage||n).createdAt,Se.cache("upsert channel",n),u.upsert(n.serialize(),function(e,n){t(),r(e,n)})):(t(),r(_e.create(_e.Type.ERROR_SETUP_MISSING)))})}function s(e){if(e){e=n.GroupChannel.buildFromSerializedData(e);return e.lastMessageUpdatedAt=(e.lastMessage||e).createdAt,e}return null}var e=this,u=o.collection("GroupChannel"),c=new O;return this.query=function(e,n,a){var t=jn.getInstance();t.currentUserId?(e.ownerUserId=t.currentUserId,e=new jn.LocalDB.Query(e),n&&(e.offset=n.offset||0,e.limit=n.limit||20,e.index=n.index,e.desc=n.desc),u.find(e,function(e,n){if(e)a(e);else{for(var t=[],r=0;r<n.length;r++){var i=s(n[r]);t.push(i)}a(null,t)}})):a(_e.create(_e.Type.ERROR_SETUP_MISSING))},this.insert=function(t,r){e.getItem(t.url,function(e,n){e?r(e):n?r(null,t):i(t,function(e){e?r(e):r(null,t)})})},this.upsert=function(n,t){i(n,function(e){e?t(e):t(null,n)})},this.remove=function(n,t){var a,s;a=n,s=function(e){e?t(e):t(null,n)},c.lock(function(r){var i=jn.getInstance();i.currentUserId?(Se.cache("remove channel",a.url),u.remove(a.url,function(e,n){var t;e?(r(),s(e)):(t=new jn.LocalDB.Query({ownerUserId:i.currentUserId,channelUrl:a.url}),o.collection("MessageChunk").removeIf(t,function(e){e?(r(),s(e)):o.collection("Message").removeIf(t,function(e){r(),e?s(e):s(null,n)})}))})):(r(),s(_e.create(_e.Type.ERROR_SETUP_MISSING)))})},this.getItem=function(e,t){u.findById(e,function(e,n){e?t(e):t(null,s(n))})},this.clear=function(e){return t=e,void c.lock(function(n){Se.cache("clear channel"),u.clear(function(e){e?(n(),t(e)):o.collection("MessageChunk").clear(function(e){n(),e?t(e):o.collection("Message").clear(t)})})});var t},this},Te={},Re=function(e,t){var n=this,a=e.collection("GroupChannelListQuery"),s=function(e){if(e){var n=t.GroupChannelListQuery.buildFromSerializedData(e);return n.filterKey=e.filterKey,n.ownerUserId=e.currentUserId,n.updatedAt=e.updatedAt,n.savepoint=e.savepoint,n}return null};return this.createFilterKey=function(e){var n=[];return n.push("order=".concat(e.order)),n.push("includeEmpty=".concat(e.includeEmpty)),n.push("customTypesFilter=".concat(e.customTypesFilter.sort().join(","))),n.join("&")},this.upsert=function(e,t){!function(r,i){r.filterKey=n.createFilterKey(r);var e=jn.getInstance();e.currentUserId?(Se.cache("upsert channel list query",r.filterKey),r.ownerUserId=e.currentUserId,r.updatedAt=(new Date).getTime(),r.savepoint||(r.savepoint=""),e=r.serialize(),a.upsert(e,function(e,n){if(e)i(e);else{if(Te[r.filterKey])for(var t in r)Te[r.filterKey].hasOwnProperty(t)&&(Te[r.filterKey][t]=r[t]);else Te[r.filterKey]=r;i(null,s(n))}})):i(_e.create(_e.Type.ERROR_SETUP_MISSING))}(e,function(e,n){e?t(e):t(null,s(n))})},this.remove=function(e,t){var r,i;r=e,i=function(e,n){e?t(e):t(null,s(n))},jn.getInstance().currentUserId?(Se.cache("remove channel list query",r.filterKey),a.remove(r.filterKey,function(e,n){e?i(e):(Te[r.filterKey]&&delete Te[r.filterKey],i(null,n))})):i(_e.create(_e.Type.ERROR_SETUP_MISSING))},this.getItem=function(e,t){Te[e]?t(null,Te[e]):a.findById(e,function(e,n){e?t(e):t(null,s(n))})},this.clear=function(e){return n=e,Se.cache("clear channel list query"),Te={},void a.clear(function(e){return n(e)});var n},this};function Ue(e,n){return(1<arguments.length&&void 0!==n?n:[]).map(function(e){return e.url}).indexOf(e.url)}function De(e,n){for(var t=1<arguments.length&&void 0!==n?n:[],r=0;r<t.length;r++)if(e.isIdentical(t[r]))return r;return-1}"undefined"==typeof Promise&&(Promise=e);function Ne(n,t){var e=f(n),r=f(t);return!n||!t||"object"!==e||e!==r||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===e&&"function"===r||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(e){return Ne(n[e],t[e])})}function xe(e,n){if(!n)return new Promise(function(n,t){e(function(e){return e?t(e):n()})});e(n)}var Fe=function(){var t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:3&n|8).toString(16)})},Pe="unsent";function Le(e){return"".concat(Pe,"-").concat(e)}function qe(e){if(e)if(e.sendingStatus&&"succeeded"!==e.sendingStatus){if(!e.reqId)throw _e.throw(_e.create(_e.Type.ERROR_INVALID_PARAMETER));e.messageId=Le(e.reqId)}else e.messageId="".concat(e.messageId)}var Be=function(e,r){function s(n,i){u.lock(function(t){var e=jn.getInstance(),r=n.isDeleted?n:l(n.serialize());qe(r),r.messageId?e.currentUserId?(r.hasOwnProperty("isVisible")||(r.isVisible=!0),r.hasOwnProperty("isDeleted")||(r.isDeleted=!1),r.ownerUserId=e.currentUserId,Se.cache("upsert message","owner="+r.ownerUserId,"visible="+r.isVisible,"deleted="+r.isDeleted,r),c.findById(r.messageId,function(e,n){e?(t(),i(e)):n?!n.isDeleted&&("pending"!==r.sendingStatus||"pending"===n.sendingStatus)?(r.isVisible=r.isVisible||n.isVisible,c.upsert(r.serialize(),function(e,n){t(),e?i(e):i(null,n)})):(t(),i(null,n)):c.upsert(r.serialize(),function(e,n){t(),e?i(e):i(null,n)})})):(t(),i(_e.create(_e.Type.ERROR_SETUP_MISSING))):(t(),i(null,n))})}function a(e,n){return n.messageType&&(e.messageType=n.messageType),n.customType&&(e.customType=n.customType),n.senderUserIdsFilter&&0<n.senderUserIdsFilter.length&&(e["sender.userId"]={"/in":n.senderUserIdsFilter}),e}var o=this,u=new O,c=e.collection("Message"),l=function(e){var n,t=null;return e&&("user"===e.messageType?t=r.UserMessage.buildFromSerializedData(e):"file"===e.messageType?t=r.FileMessage.buildFromSerializedData(e):"admin"===e.messageType&&(t=r.AdminMessage.buildFromSerializedData(e))),t&&((n=t)&&(n.sendingStatus&&"succeeded"!==n.sendingStatus?n.messageId=0:n.messageId=parseInt(n.messageId)),"pending"===t.sendingStatus&&(t.pendingResolveTop=e.pendingResolveTop,t.pendingResolveBottom=e.pendingResolveBottom)),t};return this.query=function(e,n,a){e.isVisible=!0,e.isDeleted=!1;var t=jn.getInstance();t.currentUserId?(e.ownerUserId=t.currentUserId,e=new jn.LocalDB.Query(e),n&&(e.offset=n.offset||0,e.limit=n.limit||50,e.desc=n.desc),e.index={ownerUserId:jn.LocalDB.Query.Order.ASC,channelUrl:jn.LocalDB.Query.Order.ASC,createdAt:jn.LocalDB.Query.Order.DESC},c.find(e,function(e,n){if(e)a(e);else{for(var t=[],r=0;r<n.length;r++){var i=l(n[r]);t.push(i)}a(null,t)}})):a(_e.create(_e.Type.ERROR_SETUP_MISSING))},this.find=function(e,n){c.find(e,n)},this.count=function(e,n){c.count(e,n)},this.upsert=function(e,t){e?s(e,function(e,n){e?t(e):t(null,l(n))}):t(null)},this.remove=function(i,a){o.getItem(i,function(e,n){var t=jn.getInstance(),r={messageId:i,isDeleted:!0,serialize:function(){return{messageId:"".concat(i),ownerUserId:n?n.ownerUserId:t.currentUserId,channelUrl:n?n.channelUrl:"",createdAt:n?n.createdAt:0,sendingStatus:n?n.sendingStatus:"succeeded",isVisible:!1,isDeleted:!0}}};s(r,function(e){e?a(e):a(null,i)})})},this.removeUnsent=function(e,t){e=Le(e);o.getItem(e,function(e,n){var r,i;e?t(e):n?(r=n,i=t,u.lock(function(t){jn.getInstance().currentUserId?(Se.cache("remove message",r.messageId),qe(r),c.remove(r.messageId,function(e,n){t(),i(e,n)})):(t(),i(_e.create(_e.Type.ERROR_SETUP_MISSING)))})):t(null)})},this.removeExpiredMessages=function(e,n){e=(new Date).getTime()-864e5*e,e=new jn.LocalDB.Query({ownerUserId:jn.getInstance().currentUserId,sendingStatus:"failed",createdAt:{"<":e}});e.limit=Number.MAX_SAFE_INTEGER,e.index={ownerUserId:jn.LocalDB.Query.Order.ASC,createdAt:jn.LocalDB.Query.Order.ASC},c.removeIf(e,n)},this.loadMessagesByHistoryOffset=function(e,n,t){n={channelUrl:n,createdAt:{"<":e},ownerUserId:jn.getInstance().currentUserId},e={};e.limit=Number.MAX_SAFE_INTEGER,e.desc=!0,o.query(n,e,t)},this.clearMessagesByHistoryOffset=function(e,n,t){e=new jn.LocalDB.Query({channelUrl:n,ownerUserId:jn.getInstance().currentUserId,createdAt:{"<":e}});e.limit=Number.MAX_SAFE_INTEGER,e.index={ownerUserId:jn.LocalDB.Query.Order.ASC,channelUrl:jn.LocalDB.Query.Order.ASC,createdAt:jn.LocalDB.Query.Order.DESC},c.removeIf(e,t)},this.getItemWithVisibility=function(e,t){c.findById(e,function(e,n){e?t(e):t(null,{item:l(n),isVisible:!!n&&n.isVisible})})},this.getItem=function(e,t){c.findById(e,function(e,n){e?t(e):t(null,l(n))})},this.clear=function(e){return t=e,void u.lock(function(n){Se.cache("clear messages"),c.clear(function(e){n(),t(e)})});var t},this.loadPreviousSucceededMessages=function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:(new Date).getTime(),r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},i=4<arguments.length?arguments[4]:void 0,t={channelUrl:e,sendingStatus:"succeeded",createdAt:{"<=":t}};a(t,n),r.desc=!0,o.query(t,r,i)},this.loadNextSucceededMessages=function(e){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},t=4<arguments.length?arguments[4]:void 0,e={channelUrl:e,sendingStatus:"succeeded",createdAt:{">=":2<arguments.length&&void 0!==arguments[2]?arguments[2]:0}};a(e,1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}),n.desc=!1,o.query(e,n,t)},this.loadFailedMessages=function(e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},t=3<arguments.length?arguments[3]:void 0,e={channelUrl:e,sendingStatus:"failed"};a(e,1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}),n.limit=Number.MAX_SAFE_INTEGER,n.desc=!0,o.query(e,n,t)},this.loadOldestFailedMessages=function(e){var n={sendingStatus:"failed"};a(n,{});var t={limit:Number.MAX_SAFE_INTEGER,desc:!1};o.query(n,t,e)},this.loadPendingMessages=function(e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},t=3<arguments.length?arguments[3]:void 0,e={channelUrl:e,sendingStatus:"pending"};a(e,1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}),n.limit=Number.MAX_SAFE_INTEGER,n.desc=!0,o.query(e,n,t)},this.resolvePendingMessagesAsFailed=function(e,n,t,r){t=new jn.LocalDB.Query({ownerUserId:jn.getInstance().currentUserId,channelUrl:e,sendingStatus:"pending",pendingResolveTop:{">=":n},pendingResolveBottom:{"<=":t}});c.updateIf(t,{sendingStatus:"failed"},function(e,n){r(e,n?n.map(function(e){return l(e)}):null)})},this.pullPendingResolveTop=function(e,n,t){e=new jn.LocalDB.Query({ownerUserId:jn.getInstance().currentUserId,channelUrl:e,sendingStatus:"pending",pendingResolveTop:{"<":n}});c.updateIf(e,{pendingResolveTop:n},function(e,n){t(e,n?n.map(function(e){return l(e)}):null)})},this.pullPendingResolveBottom=function(e,n,t){e=new jn.LocalDB.Query({ownerUserId:jn.getInstance().currentUserId,channelUrl:e,sendingStatus:"pending",pendingResolveBottom:Number.MAX_SAFE_INTEGER});c.updateIf(e,{pendingResolveBottom:n},function(e,n){t(e,n?n.map(function(e){return l(e)}):null)})},this},Ve={},je=function(e){var n,t=[];for(n in e)t.push("".concat(n,"=").concat(e[n]));return t.join("&")},Ge=function(){function t(e,n){l(this,t),this.chunkId=Fe(),this.channelUrl=e,this.filterKey=je(n),this.filter=n,this.startAt=(new Date).getTime(),this.endAt=0}return c(t,[{key:"hasDefaultFilter",value:function(){var e=t.getDefaultFilter();return Ne(this.filter,e)}},{key:"isOverlap",value:function(e){return e.startAt<=this.startAt&&this.startAt<=e.endAt||e.startAt<=this.endAt&&this.endAt<=e.endAt}},{key:"isSame",value:function(e){return!!e&&(e.startAt===this.startAt&&this.endAt===e.endAt)}},{key:"contains",value:function(e){return this.startAt<=e&&e<=this.endAt}},{key:"containsMessage",value:function(e){return this.contains(e.createdAt)}},{key:"serialize",value:function(){var e=JSON.parse(JSON.stringify(this));return Object.freeze(e)}},{key:"extendForward",value:function(e){this.endAt=Math.max(this.endAt,e)}},{key:"extendBackward",value:function(e){this.startAt=Math.min(this.startAt,e)}},{key:"extendWithChunk",value:function(e){return this.extendForwardWithChunk(e),this.extendBackwardWithChunk(e),this}},{key:"extendForwardWithChunk",value:function(e){return this.extendForward(e.endAt),this}},{key:"extendBackwardWithChunk",value:function(e){return this.extendBackward(e.startAt),this}},{key:"extendWithMessage",value:function(e){return this.extendForwardWithMessage(e),this.extendBackwardWithMessage(e),this}},{key:"extendForwardWithMessage",value:function(e){return this.extendForward(e.createdAt),this}},{key:"extendBackwardWithMessage",value:function(e){return this.extendBackward(e.createdAt),this}}],[{key:"createFromJson",value:function(e){var n=new t(e.channelUrl,e.filter);return n.chunkId=e.chunkId,n.startAt=e.startAt,n.endAt=e.endAt,n}},{key:"getDefaultFilter",value:function(){return{messageTypeFilter:null,customTypeFilter:null,senderUserIdsFilter:[],includeMetaArray:!0}}},{key:"MessageTypeFilterRealValue",get:function(){return["","user","file","admin"]}}]),t}(),Qe=function(e){var o=this,u=e.collection("MessageChunk"),i=new O;return this.reload=function(e,n){return u.findById(e.chunkId,n)},this.upsert=function(e,t){var n,r;n=e,r=function(e,n){e?t(e):t(null,Ge.createFromJson(n))},i.lock(function(t){var e=jn.getInstance();e.currentUserId?(n.ownerUserId=e.currentUserId,Ve[n.chunkId]=n,u.upsert(Ve[n.chunkId].serialize(),function(e,n){t(),e?r(e):r(null,n)})):(t(),r(_e.create(_e.Type.ERROR_SETUP_MISSING)))})},this.remove=function(n,t){var e,r;e=n,r=function(e){e?t(e):t(null,n)},i.lock(function(t){jn.getInstance().currentUserId?(Ve[e]&&delete Ve[e],u.remove(e,function(e,n){t(),e?r(e):r(null,n)})):(t(),r(_e.create(_e.Type.ERROR_SETUP_MISSING)))})},this.clear=function(e){return t=e,void i.lock(function(n){Ve={},u.clear(function(e){n(),t(e)})});var t},this.getChunksByHistoryOffset=function(e,n,t){var r=jn.getInstance(),i=Ge.getDefaultFilter();r.currentUserId&&((e=new jn.LocalDB.Query({ownerUserId:r.currentUserId,channelUrl:n,filterKey:je(i),endAt:{"<=":e}})).limit=Number.MAX_SAFE_INTEGER,e.index={ownerUserId:jn.LocalDB.Query.Order.ASC,channelUrl:jn.LocalDB.Query.Order.ASC,filterKey:jn.LocalDB.Query.Order.ASC,endAt:jn.LocalDB.Query.Order.DESC},u.find(e,t))},this.clearChunkByHistoryOffset=function(i,n,t){var e,r,a=jn.getInstance(),s=Ge.getDefaultFilter();a.currentUserId&&(e=new Promise(function(t,r){var e=new jn.LocalDB.Query({ownerUserId:a.currentUserId,channelUrl:n,filterKey:je(s),endAt:{"<=":i}});e.limit=Number.MAX_SAFE_INTEGER,e.index={ownerUserId:jn.LocalDB.Query.Order.ASC,channelUrl:jn.LocalDB.Query.Order.ASC,filterKey:jn.LocalDB.Query.Order.ASC,endAt:jn.LocalDB.Query.Order.DESC},u.removeIf(e,function(e,n){return e?r(e):t(n)})}),r=new Promise(function(t,r){o.getChunkByTimestamp(n,s,i,function(e,n){return e?r(e):(n&&(n.extendBackward(i),o.upsert(n,function(e,n){return e?r(e):void t(n)})),void t(n))})}),Promise.all([e,r]).then(function(e){t(null)}).catch(function(e){t(e)}))},this.getChunkByTimestamp=function(r,e,i,a){var n=jn.getInstance();n.currentUserId?((e=new jn.LocalDB.Query({ownerUserId:n.currentUserId,channelUrl:r,filterKey:je(e),startAt:{"<=":i},endAt:{">=":i}})).limit=1,e.index={ownerUserId:jn.LocalDB.Query.Order.ASC,channelUrl:jn.LocalDB.Query.Order.ASC,filterKey:jn.LocalDB.Query.Order.ASC,endAt:jn.LocalDB.Query.Order.DESC},u.find(e,function(e,n){var t;e?a(e):(t=0<n.length?Ge.createFromJson(n[0]):null)?t.hasDefaultFilter()?a(null,t):((n=new jn.LocalDB.Query({channelUrl:r,filterKey:je(Ge.getDefaultFilter()),startAt:{"<=":i}})).limit=1,n.index={ownerUserId:jn.LocalDB.Query.Order.ASC,channelUrl:jn.LocalDB.Query.Order.ASC,filterKey:jn.LocalDB.Query.Order.ASC,endAt:jn.LocalDB.Query.Order.DESC},u.find(n,function(e,n){e?a(e):(e=0<n.length?Ge.createFromJson(n[0]):null)&&e.endAt>t.endAt?e.isOverlap(t)?(t.extendWithChunk(e),o.upsert(t,a)):((n=new Ge(t.channelUrl,t.filter)).startAt=e.startAt,n.endAt=e.endAt,o.upsert(n,a)):a(null,t)})):a(null)})):a(_e.create(_e.Type.ERROR_SETUP_MISSING))},this.mergePreviousChunkOverlap=function(r,i){var e=jn.getInstance();e.currentUserId?((e=new jn.LocalDB.Query({ownerUserId:e.currentUserId,chunkId:{"!=":r.chunkId},channelUrl:r.channelUrl,filterKey:r.filterKey,endAt:{">=":r.startAt}})).limit=1/0,u.find(e,function(e,t){e?i(e):0<t.length?(e=new jn.LocalDB.Query({chunkId:{"/in":t.map(function(e){return e.chunkId})}}),u.removeIf(e,function(e){if(e)i(e);else{for(var n=0;n<t.length;n++)r.extendWithChunk(t[n]);o.upsert(r,i)}})):o.upsert(r,i)})):i(_e.create(_e.Type.ERROR_SETUP_MISSING))},this};function He(e,n,t){return t?n.channelUrl===e.url&&((!t.messageType||t.messageType===n.messageType)&&((!t.customType||t.customType===n.customType)&&!(Array.isArray(t.senderUserIdsFilter)&&0<t.senderUserIdsFilter.length&&n.sender&&t.senderUserIdsFilter.indexOf(n.sender.userId)<0))):n.channelUrl===e.url}var Ke=function(){var t={},u=[];return this.removeChannel=function(e){for(var n in u){var t=u[n];t.controller.channel.url===e.url&&t.view.channelWasRemoved(e)}},this.updateChannel=function(s){for(var e in u){var n=u[e];n.controller.channel.url===s.url&&n.view.channelWasUpdated(s)}(!t.hasOwnProperty(s.url)||s.messageOffsetTimestamp>t[s.url])&&(t[s.url]=s.messageOffsetTimestamp,t[s.url]&&(sn.getInstance().chunkContainer.clearChunkByHistoryOffset(s.messageOffsetTimestamp,s.url,function(e){e&&Se.error("Error while clearing message chunk history",e)}),sn.getInstance().messageContainer.loadMessagesByHistoryOffset(s.messageOffsetTimestamp,s.url,function(e,n){if(!e){sn.getInstance().messageContainer.clearMessagesByHistoryOffset(s.messageOffsetTimestamp,s.url,function(e,n){e&&Se.error("Error while clearing chat history",e)});var t=n.filter(function(e){return e.hasOwnProperty("sendingStatus")&&"failed"===e.sendingStatus}).map(function(e){return e.reqId}),r=n.filter(function(e){return e.hasOwnProperty("sendingStatus")&&"succeeded"===e.sendingStatus}).map(function(e){return e.messageId});if(0<r.length||0<t.length)for(var i in u){var a=u[i];a.controller.channel.url===s.url&&(0<r.length&&a.view.removeViewItems(r),0<t.length&&a.view.removeViewItems(t,{isRequestId:!0}))}}})))},this.addCollection=function(e,n){u.push({controller:e,view:n}),e.hasOwnProperty("channel")&&e.channel.hasOwnProperty("url")&&(!t.hasOwnProperty(e.channel.url)||e.channel.messageOffsetTimestamp>t[e.channel.url])&&(t[e.channel.url]=e.channel.messageOffsetTimestamp)},this.removeCollection=function(e){e=u.map(function(e){return e.controller}).indexOf(e);0<=e&&(u[e].controller._pause(),u.splice(e,1))},this.clearCollection=function(){for(var e in u)u[e].controller._pause();u=[]},this.pause=function(){for(var e in u)u[e].controller._pause()},this.resume=function(n){var e,t=u.length,r=null;for(e in u)u[e].controller._resume(function(e){r=e||r,--t<=0&&n(r)})},this.upsert=function(e,n){if(0<e.length)for(var t in u){var r=u[t];if(r.controller!==n){var i,a=[];for(i in e){var s=e[i];He(r.controller.channel,s,r.controller.filter)&&a.push(s)}0<a.length&&r.view.addViewItems(a,{isEventMessage:!0,direction:"next"})}}},this.update=function(e,n){if(0<e.length)for(var t in u){var r=u[t];if(r.controller!==n){var i,a=[],s=[];for(i in e){var o=e[i];0<=r.view.messages.map(function(e){return e.messageId}).indexOf(o.messageId)&&(He(r.controller.channel,o,r.controller.filter)?a:s).push(o)}0<a.length&&r.view.addViewItems(a,{isEventMessage:!0,direction:"next"}),0<s.length&&r.view.removeViewItems(s)}}},this.read=function(e,n){for(var t in u){var r=u[t];r.controller!==n&&r.controller.channel.url===e.url&&(r.controller.channel=e,r.view.addViewItems(r.view.messages))}},this.remove=function(e,n){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(0<e.length)for(var r in u){var i=u[r];i.controller!==n&&i.view.removeViewItems(e,t)}},this.clear=function(){for(var e in t={},u)u[e].view.clearViewItem()},this.updateCurrentChunk=function(e){for(var n in u)u[n].view.updateCurrentChunk(e)},this};function We(){this.onChannelEvent=function(e,n){}}function ze(){this.onPendingMessageEvent=function(e,n){},this.onFailedMessageEvent=function(e,n,t){},this.onSucceededMessageEvent=function(e,n){},this.onNewMessage=function(e){},this.onMessageEvent=function(e,n){},this.onChannelRemoved=function(e){},this.onChannelUpdated=function(e){}}var Je={INSERT:"insert",UPDATE:"update",MOVE:"move",REMOVE:"remove",CLEAR:"clear"},Xe={INSERT:"insert",UPDATE:"update",REMOVE:"remove",CLEAR:"clear"},Ye={NONE:"none",UPDATE_RESEND_FAILED:"update_resend_failed",REMOVE_RESEND_SUCCEEDED:"remove_resend_succeeded",REMOVE_RETENTION_EXPIRED:"remove_retention_expired",REMOVE_EXCEEDED_MAX_COUNT:"remove_exceeded_max_count",REMOVE_MANUAL_ACTION:"remove_manual_action",REMOVE_UNKNOWN:"remove_unknown"},$e=function(){function r(e){var n=this,e=e.channelUrl;l(this,r),this._resendingTimer=null;var t=!1;Object.defineProperty(this,"_isRunning",{get:function(){return t},set:function(e){t!==(t=e)&&n._toggleResendingInterval()}}),this._clear(),this.collectionReferenceCount=1,this._channelUrl=e}return c(r,[{key:"_clear",value:function(e){e=0<arguments.length&&void 0!==e?e:{noManualMessages:!1};this._retryCount=0,this._delayTime=0,this._isRunning=!1,e.noManualMessages||(this.manualMessages=[]),this.automaticMessages=[],clearTimeout(this._resendingTimer),this._resendingTimer=null}},{key:"_appendMessagesWithOrder",value:function(e,n){var a=this,n=1<arguments.length&&void 0!==n?n:{},s=n.hasOwnProperty("isAutomatic")?n.isAutomatic:jn.syncManagerOptions.messageResendPolicy===jn.Options.MessageResendPolicy.AUTOMATIC;e.forEach(function(e){for(var n=(s?a.automaticMessages:a.manualMessages).length,t=n,r=0;r<n;r++){var i=(s?a.automaticMessages:a.manualMessages)[r];if(e.createdAt<i.createdAt){t=r;break}}(s?a.automaticMessages:a.manualMessages).splice(t,0,e)})}},{key:"appendMessages",value:function(t){for(var r=this,e=0===this.automaticMessages.length,i=jn.syncManagerOptions.messageResendPolicy===jn.Options.MessageResendPolicy.AUTOMATIC,n=t.length,a=[],s=0;s<n;s++)!function(e){var n=t[e];0;e=[];i&&(e=r.automaticMessages),0<[].concat(q(e),q(r.manualMessages)).filter(function(e){return e.reqId===n.reqId}).length||a.push(n)}(s);this._appendMessagesWithOrder(a),e&&0<this.automaticMessages.length&&this._resendUserMessage()}},{key:"removeMessages",value:function(t){for(var r=this,i=jn.syncManagerOptions.messageResendPolicy===jn.Options.MessageResendPolicy.AUTOMATIC,e=t.length,a=!1,n=0;n<e;n++)!function(e){var n=t[e];a=!1,i&&(r.automaticMessages=r.automaticMessages.filter(function(e){return e.reqId!==n.reqId||!(a=!0)})),a||(r.manualMessages=r.manualMessages.filter(function(e){return e.reqId!==n.reqId}))}(n)}},{key:"_resendUserMessage",value:function(){var o=this;if(this._retryCount++,jn.syncManagerOptions.automaticMessageResendRetryCount!==jn.Options.INFINITY&&this._retryCount>jn.syncManagerOptions.automaticMessageResendRetryCount)return this._appendMessagesWithOrder(this.automaticMessages,{isAutomatic:!1}),this.automaticMessages=[],nn.getInstance().upsertMessages(this._channelUrl,this.manualMessages),void this._clear({noManualMessages:!0});this._resendingTimer=setTimeout(function(){var i,e,a,s=o.automaticMessages[0];s&&o._isRunning?(e=(i=sn.getInstance()).sb,a=e.getErrorFirstCallback(),e.GroupChannel.getChannel(o._channelUrl,function(e,n){var t;a&&(t=n,n=e,e=t),n?(o._increaseDelayTime(),o._resendUserMessage()):e.resendUserMessage(s,function(e,n){var t,r;a&&(t=n,n=e,e=t),n?(800110===n.code?(r={reason:Ye.REMOVE_UNKNOWN},nn.getInstance().removeMessages(o._channelUrl,[s],r),o.removeMessages([s])):o._increaseDelayTime(),o._resendUserMessage()):(o.removeMessages([s]),o._retryCount=0,o._delayTime=0,r={reason:Ye.REMOVE_RESEND_SUCCEEDED},nn.getInstance().removeMessages(o._channelUrl,[s],r),i.messageContainer.upsert(e,function(e,n){e||i.broadcast.upsert([n]),o._resendUserMessage()}))})})):(o._retryCount=0,o._delayTime=0)},this._delayTime)}},{key:"_increaseDelayTime",value:function(){this._delayTime=1e4===this._delayTime?this._delayTime:this._delayTime+2e3}},{key:"_toggleResendingInterval",value:function(){this._isRunning?this._resendUserMessage():(clearTimeout(this._resendingTimer),this._resendingTimer=null,this._retryCount=0,this._delayTime=0)}},{key:"resumeResending",value:function(){Se.call("FailedMessageQueue resumeResending()"),this._retryCount=0,this._delayTime=0,this._isRunning=!0}},{key:"pauseResending",value:function(){Se.call("FailedMessageQueue pauseResending()"),this._isRunning=!1}},{key:"increaseCount",value:function(){++this.collectionReferenceCount}},{key:"decreaseCount",value:function(){--this.collectionReferenceCount,0===this.collectionReferenceCount&&this._clear()}}]),r}(),Ze=function(){function r(e){var n=e.msec,t=void 0===n?0:n,n=e.isEternal,n=void 0===n||n,e=e.timeoutFn,e=void 0===e?function(){}:e;l(this,r),this.time=t,this.isEternal=n,this.timeoutFn=e,this.checker=null}return c(r,[{key:"reset",value:function(){this.stop(),this.time=0,this.timeoutFn=function(){}}},{key:"start",value:function(){var e,n=this;null===this.checker&&(e=(new Date).getTime(),this.checker=setTimeout(function(){(new Date).getTime()-e>=n.time&&(n.isEternal?n.start():n.stop(),n.timeoutFn&&"function"==typeof n.timeoutFn&&n.timeoutFn())},432e5))}},{key:"stop",value:function(){clearTimeout(this.checker),this.checker=null}}]),r}(),en=null,nn=function(){function e(){if(l(this,e),en)return en;this.queueMap={},this.expirationTimer=new Ze({msec:864e5*jn.syncManagerOptions.failedMessageRetentionDays,isEternal:!0,timeoutFn:this.removeExpiredMessages}),this.oldestFailedMessageTs=0,en=this}return c(e,[{key:"getMessages",value:function(e){return this.queueMap[e]?this.queueMap[e].messages:[]}},{key:"loadFailedMessages",value:function(i,a,s){var o=this;sn.getInstance().messageContainer.loadFailedMessages(i,{},{},function(e,n){var t,r=n;e||(Se.cache("fetch failed message",n.map(function(e){return e.reqId})),(t=o.queueMap[i])&&(t.appendMessages(n),t.resumeResending()),r=n.filter(function(e){var n=!0,t=!0,r=!0;if(a.messageTypeFilter&&(n=e.messageType===Ge.MessageTypeFilterRealValue[a.messageTypeFilter]),a.customTypeFilter&&(t=e.customType===a.customTypeFilter),a.senderUserIdsFilter&&Array.isArray(a.senderUserIdsFilter)&&0<a.senderUserIdsFilter.length&&(r=e.sender&&-1<a.senderUserIdsFilter.indexOf(e.sender.userId)),n&&t&&r)return e})),s(e,r)})}},{key:"removeExpiredMessages",value:function(t){var i=this;this.expirationTimer.stop();var e=Math.floor(((new Date).getTime()-this.oldestFailedMessageTs)/864e5);if(0!==this.oldestFailedMessageTs&&e<jn.syncManagerOptions.failedMessageRetentionDays)return this.expirationTimer.start(),void(t&&t());var a=sn.getInstance(),e=jn.syncManagerOptions.failedMessageRetentionDays;a.messageContainer.removeExpiredMessages(e,function(e,n){if(e)return Se.error("Fail remove expired failedMessage by failedMessageRetentionDays:",e),i.expirationTimer.start(),void(t&&t());var r={};n.forEach(function(e){var n=e.channelUrl;r[n]&&Array.isArray(r[n])||(r[n]=[]),r[n].push(e)}),Object.keys(r).forEach(function(e){var n=r[e].map(function(e){return e.reqId}),t={isRequestId:!0,reason:Ye.REMOVE_RETENTION_EXPIRED};a.broadcast.remove(n,{},t),i.queueMap.hasOwnProperty(e)&&i.queueMap[e].removeMessages(r[e])}),a.messageContainer.loadOldestFailedMessages(function(e,n){e?(Se.error("Fail get oldestFailedMessage from DB: ",e),i.oldestFailedMessageTs=0):i.oldestFailedMessageTs=0<n.length?n[0].createdAt:(new Date).getTime(),i.expirationTimer.start(),t&&t()})})}},{key:"removeExceedingMaxCount",value:function(e){var i=this,a=sn.getInstance(),t=new jn.LocalDB.Query({ownerUserId:jn.getInstance().currentUserId,channelUrl:e,sendingStatus:"failed"});t.limit=Number.MAX_SAFE_INTEGER,t.index={ownerUserId:jn.LocalDB.Query.Order.ASC,createdAt:jn.LocalDB.Query.Order.ASC},a.messageContainer.count(t,function(e,n){e?Se.error("Get count about failedMessage by maxFailedMessageCountPerChannel:",e):(e=jn.syncManagerOptions.maxFailedMessageCountPerChannel)<n&&(t.limit=n-e,a.messageContainer.find(t,function(e,n){var r={isRequestId:!0,reason:Ye.REMOVE_EXCEEDED_MAX_COUNT};n.forEach(function(n){var t=n.reqId;a.messageContainer.removeUnsent(t,function(e){e&&Se.error("Fail remove count failedMessage by maxFailedMessageCountPerChannel:",e),a.broadcast.remove([t],{},r),i.queueMap[n.channelUrl].removeMessages([n])})})}))})}},{key:"upsertMessages",value:function(t,r){var i=this,a=sn.getInstance(),s=this.queueMap[t],o=0;r.forEach(function(e){a.messageContainer.upsert(e,function(e,n){e||a.broadcast.upsert([n]),++o===r.length&&(s&&s.appendMessages(r),i.removeExceedingMaxCount(t))})})}},{key:"removeMessages",value:function(e,n,t){var r=sn.getInstance(),i=this.queueMap[e];n.forEach(function(n){n.reqId&&r.messageContainer.removeUnsent(n.reqId,function(e){e?Se.error("deleteMessage()","Failed to delete message from cache: ".concat(n)):(t.isRequestId=!0,r.broadcast.remove([n.reqId],{},t),i&&i.removeMessages([n]))})})}},{key:"resume",value:function(){var e=this;Se.call("FailedMessageDispatcher resume()"),this.removeExpiredMessages(function(){e.resumeAllQueues()})}},{key:"pause",value:function(){Se.call("FailedMessageDispatcher pause()"),this.pauseAllQueues(),this.expirationTimer.stop()}},{key:"resumeAllQueues",value:function(){var n=this;Object.keys(this.queueMap).forEach(function(e){e=n.queueMap[e];e&&e.resumeResending()})}},{key:"pauseAllQueues",value:function(){var n=this;Object.keys(this.queueMap).forEach(function(e){e=n.queueMap[e];e&&e.pauseResending()})}},{key:"createQueue",value:function(e){var n=this.queueMap[e];n?n.increaseCount():this.queueMap[e]=new $e({channelUrl:e}),this.queueMap[e].resumeResending()}},{key:"removeQueue",value:function(e){var n=this.queueMap[e];n&&(n.decreaseCount(),0===n.collectionReferenceCount&&delete this.queueMap[e])}}],[{key:"getInstance",value:function(){return new e}}]),e}();"undefined"==typeof Promise&&(Promise=e);var tn="last-changeLog-token-",rn="syncManager_messageManager_channelHandler_"+(new Date).getTime(),an=null,sn=function(){function r(e){var n,t=e.sendBird,e=e.db;return l(this,r),an||(Se.call("MessageManager()"),(an=this).sb=t,t=this.sb,this.messageContainer=new Be(e,t),this.chunkContainer=new Qe(e),this.broadcast=new Ke,this.isFetchingChangeLogByChannelUrl={},n=new t.ChannelHandler,Object.keys(n).forEach(function(s){n[s]=function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];switch(s){case"onMessageReceived":Se.event(s,n[0].url,n[1].messageId,n[1].createdAt,n[1].message),n[1].isVisible=!0,an.messageContainer.upsert(n[1],function(e,n){e?_e.throw(e):an.broadcast.upsert([n])});break;case"onReadReceiptUpdated":Se.event(s,n[0].url);var r=n[0];an.broadcast.read(r);break;case"onMessageUpdated":Se.event(s,n[0].url,n[1].messageId,n[1].createdAt,n[1].message),n[1].isVisible=!1,an.messageContainer.upsert(n[1],function(e,n){e?_e.throw(e):an.broadcast.update([n])});break;case"onMessageDeleted":var i=n[0],a=n[1];an.messageContainer.getItem(a,function(e,r){e?_e.throw(e):(Se.event(s,i.url,r.messageId,r.createdAt),an.messageContainer.remove(a,function(e,n){e?_e.throw(e):(e=Ge.getDefaultFilter(),an.chunkContainer.getChunkByTimestamp(i.url,e,r.createdAt,function(e,t){!e&&t&&((e=new jn.LocalDB.Query({ownerUserId:jn.getInstance().currentUserId,channelUrl:i.url,sendingStatus:"succeeded",createdAt:{"<":r.createdAt}})).index={ownerUserId:jn.LocalDB.Query.Order.ASC,createdAt:jn.LocalDB.Query.Order.ASC},e.desc=!0,e.limit=1,an.messageContainer.find(e,function(e,n){e||(n&&0!==n.length?(t.endAt=n[0].createdAt,an.chunkContainer.upsert(t,function(e,n){e||an.broadcast.updateCurrentChunk(n)})):an.chunkContainer.remove(t.chunkId,function(e){e||an.broadcast.updateCurrentChunk(null)}))}))}),an.broadcast.remove([parseInt(n)]))}))})}}}),t.addChannelHandler(rn,n)),an}return c(r,[{key:"syncChangeLog",value:function(r,e){var i,a=this,s=1<arguments.length&&void 0!==e?e:function(){};this.isFetchingChangeLogByChannelUrl[r.url]?s(_e.create(_e.Type.ERROR_DUPLICATED_CHANGELOG_SYNC)):(this.isFetchingChangeLogByChannelUrl[r.url]=!0,Se.call("message syncChangeLog()",r.url),i="".concat(tn).concat(r.url),Ee.get(i).then(function(e){var n="getMessageChangeLogsByToken",t=[];e?(n="getMessageChangeLogsByToken",t.unshift(e)):(n="getMessageChangeLogsByTimestamp",t.unshift((new Date).getTime()-100)),Se.call(n),r[n].apply(r,t.concat([function(e,n){var t;a.sb.getErrorFirstCallback()&&(t=e,e=n,n=t),n?a.isFetchingChangeLogByChannelUrl[r.url]=!1:(Se.sync("updated",e.updatedMessages.map(function(e){return e.messageId})),Se.sync("deleted",e.deletedMessageIds),e.updatedMessages.forEach(function(r){an.messageContainer.getItemWithVisibility(r.messageId,function(e,n){var t;e||(t=n.item,r.isVisible=n.isVisible||!1,an.messageContainer.upsert(r,function(e,n){e?_e.throw(e):t&&t.isEqual(n)||an.broadcast.update([n])}))})}),e.deletedMessageIds.forEach(function(n){an.messageContainer.remove(n,function(e){e?_e.throw(e):an.broadcast.remove([n])})}),Ee.set(i,e.token).then(function(){e.hasMore?a.syncChangeLog(r,s):(a.isFetchingChangeLogByChannelUrl[r.url]=!1,s())}).catch(function(e){a.isFetchingChangeLogByChannelUrl[r.url]=!1,s(e)}))}]))}).catch(function(e){a.isFetchingChangeLogByChannelUrl[r.url]=!1,s(e)}))}},{key:"start",value:function(){an.broadcast.resume(function(e){e||nn.getInstance().resume()})}},{key:"stop",value:function(){an.broadcast.pause(),nn.getInstance().pause()}},{key:"clearCache",value:function(t){an.messageContainer.clear(function(){an.chunkContainer.clear(function(){Ee.getKeys().then(function(e){var n=[];e.forEach(function(e){e.startsWith(tn)&&n.push(Ee.remove(e))}),Promise.all(n).then(function(){return t()}).catch(function(e){Se.error(e),t(e)})}).catch(function(e){return t(e)})})})}},{key:"reset",value:function(e){an?(an.broadcast.clear(),an.clearCache(e)):e(null)}}],[{key:"getInstance",value:function(){return an}},{key:"clear",value:function(){an&&an.sb&&(Se.message("MessageManager is cleared"),an.broadcast.clearCollection(),an.sb.removeChannelHandler(rn),an=null)}}]),r}();function on(e,n){var t=fn.getInstance().sb,r=!0;if(e.isGroupChannel()&&!e.isSuper){if(!n.includeEmpty&&!e.lastMessage)return;if(n.nicknameContainsFilter){var i,a=!1;for(i in e.members)if(0<=e.members[i].nickname.indexOf(n.nicknameContainsFilter)){a=!0;break}if(!a)return}if(n.userIdsFilter&&Array.isArray(n.userIdsFilter)&&0<n.userIdsFilter.length){var s=!1,o=e.members.map(function(e){return e.userId}),u=n.userIdsFilterExactMatch,c=n.queryType;if(u?s=o.length===n.userIdsFilter.length&&n.userIdsFilter.every(function(e){return 0<=o.indexOf(e)}):"AND"===c?s=n.userIdsFilter.every(function(e){return 0<=o.indexOf(e)}):"OR"===c&&(s=n.userIdsFilter.reduce(function(e,n){return e||0<=o.indexOf(n)},!1)),!s)return}}if(n.channelNameContainsFilter&&(r=r&&0<=e.name.indexOf(n.channelNameContainsFilter)),0<n.channelUrlsFilter.length&&(r=r&&0<=n.channelUrlsFilter.indexOf(e.url)),n.memberStateFilter!==t.GroupChannel.MemberStateFilter.ALL)switch(n.memberStateFilter){case t.GroupChannel.MemberStateFilter.JOINED:r=r&&"joined"===e.myMemberState&&"joined_only"===t.GroupChannel.MemberStateFilter.JOINED;break;case t.GroupChannel.MemberStateFilter.INVITED:case t.GroupChannel.MemberStateFilter.INVITED_BY_FRIEND:case t.GroupChannel.MemberStateFilter.INVITED_BY_NON_FRIEND:r=r&&"invited"===e.myMemberState&&("invited_only"===t.GroupChannel.MemberStateFilter.INVITED||"invited_by_friend"===t.GroupChannel.MemberStateFilter.INVITED||"invited_by_non_friend"===t.GroupChannel.MemberStateFilter.INVITED)}if(0<n.customTypesFilter.length&&(r=r&&0<=n.customTypesFilter.indexOf(e.customType)),n.customTypeStartsWithFilter&&(r=r&&e.customType.startsWith(n.customTypeStartsWithFilter)),n.superChannelFilter!==t.GroupChannel.SuperChannelFilter.ALL)switch(n.superChannelFilter){case t.GroupChannel.SuperChannelFilter.SUPER:r=r&&e.isSuper;break;case t.GroupChannel.SuperChannelFilter.NONSUPER:r=r&&!e.isSuper}if(n.publicChannelFilter!==t.GroupChannel.PublicChannelFilter.ALL)switch(n.publicChannelFilter){case t.GroupChannel.PublicChannelFilter.PUBLIC:r=r&&e.isPublic;break;case t.GroupChannel.PublicChannelFilter.PRIVATE:r=r&&!e.isPublic}return n.unreadChannelFilter!==t.GroupChannel.UnreadChannelFilter.ALL&&n.unreadChannelFilter===t.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE&&(r=r&&0<e.unreadMessageCount),r}var un=function(){var h=[];return this.addCollection=function(e,n){h.indexOf(e)<0&&h.push({controller:e,view:n})},this.removeCollection=function(e){e=h.map(function(e){return e.controller}).indexOf(e);0<=e&&(h[e].controller._pause(),h.splice(e,1))},this.clearCollection=function(){for(var e in h)h[e].controller._pause();h=[]},this.pause=function(){for(var e in h)h[e].controller._pause()},this.resume=function(){for(var e in h)h[e].controller._resume()},this.upsert=function(e,n){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(0<e.length)for(var r in h){var i=h[r];if(i.controller!==n){var a,s=[];for(a in e){var o=e[a];on(o,i.controller.query)&&s.push(o)}0<s.length&&(t.isEventChannel=!0,i.view.addViewItems(s,t))}}},this.update=function(e,n){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(0<e.length){for(var r in e){var i=e[r];sn.getInstance().broadcast.updateChannel(i)}for(var a in h){var s=h[a];if(s.controller!==n){var o,u=[],c=[];for(o in e){var l=e[o];s.view.channels.map(function(e){return e.url}).includes(l.url)&&(on(l,s.controller.query)?u:c).push(l)}0<u.length&&(t.isEventChannel=!0,s.view.addViewItems(u,t)),0<c.length&&s.view.removeViewItems(c)}}}},this.remove=function(e,n){if(0<e.length){for(var t in e){var r=e[t];sn.getInstance().broadcast.removeChannel(r)}for(var i in h){var a=h[i];if(a.controller!==n){var s,o=[];for(s in e){var u=e[s];0<=a.view.channels.map(function(e){return e.url}).indexOf(u.url)&&o.push(u)}0<o.length&&a.view.removeViewItems(o)}}}},this.hide=function(e,n){var t,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};for(t in e){var i=e[t];sn.getInstance().broadcast.updateChannel(i)}if(0<e.length){var a,s=fn.getInstance().sb;for(a in h){var o=h[a];if(o.controller!==n){var u,c=[];for(u in e){var l=e[u];on(l,o.controller.query)&&c.push(l)}if(0<c.length)switch(o.controller.query.hiddenChannelFilter){case s.GroupChannel.HiddenChannelFilter.UNHIDDEN:o.view.removeViewItems(c);break;case s.GroupChannel.HiddenChannelFilter.HIDDEN:case s.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case s.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:r.isEventChannel=!0,o.view.addViewItems(c,r)}}}}},this.unhide=function(e,n){var t,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};for(t in e){var i=e[t];sn.getInstance().broadcast.updateChannel(i)}if(0<e.length){var a,s=fn.getInstance().sb;for(a in h){var o=h[a];if(o.controller!==n){var u,c=[];for(u in e){var l=e[u];on(l,o.controller.query)&&c.push(l)}if(0<c.length)switch(o.controller.query.hiddenChannelFilter){case s.GroupChannel.HiddenChannelFilter.UNHIDDEN:r.isEventChannel=!0,o.view.addViewItems(c,r);break;case s.GroupChannel.HiddenChannelFilter.HIDDEN:case s.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case s.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:o.view.removeViewItems(c)}}}}},this.clear=function(){for(var e in h)h[e].view.clearViewItem()},this};"undefined"==typeof Promise&&(Promise=e);var cn="channel-changeLog-token",ln="syncManager_channelManager_channelHandler_"+(new Date).getTime(),hn=null,fn=function(){function r(e){var u,c,n,t=e.sendBird,e=e.db;return l(this,r),hn||(Se.call("ChannelManager()"),u=(hn=this).sb=t,c=jn.getInstance(),this.channelContainer=new Oe(e,u),this.queryContainer=new Re(e,u),this.broadcast=new un,this.isFetchingChangeLog=!1,this.channelSyncByFilter={},this.changeLogSync=null,n=new u.ChannelHandler,Object.keys(n).forEach(function(o){n[o]=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];switch(o){case"onChannelChanged":var r=t[0];Se.event(o,r.url),hn.channelContainer.getItem(r.url,function(e,t){e?_e.throw(e):hn.channelContainer.upsert(r,function(e,n){e?_e.throw(e):t?t.hiddenState!==u.GroupChannel.HiddenState.UNHIDDEN&&r.hiddenState===u.GroupChannel.HiddenState.UNHIDDEN?hn.broadcast.unhide([n]):hn.broadcast.update([n]):hn.broadcast.upsert([n])})});break;case"onUserMuted":case"onUserUnmuted":case"onUserUnbanned":case"onChannelFrozen":case"onChannelUnfrozen":case"onMetaDataCreated":case"onMetaDataUpdated":case"onMetaDataDeleted":case"onMetaCountersCreated":case"onMetaCountersUpdated":case"onMetaCountersDeleted":Se.event(o,t[0].url),hn.channelContainer.upsert(t[0],function(e,n){e?_e.throw(e):hn.broadcast.update([n])});break;case"onUserReceivedInvitation":case"onUserJoined":Se.event(o,t[0].url),hn.channelContainer.upsert(t[0],function(e,n){e?_e.throw(e):t[1].userId===c.currentUserId?hn.broadcast.upsert([n]):hn.broadcast.update([n])});break;case"onReadReceiptUpdated":hn.channelContainer.upsert(t[0],function(e){e&&_e.throw(e)});break;case"onChannelHidden":Se.event(o,t[0].url);var i=t[0];hn.channelContainer.upsert(i,function(e){e?_e.throw(e):hn.broadcast.hide([i])});break;case"onUserLeft":case"onUserBanned":Se.event(o,t[0].url);var a=t[0];t[1].userId===c.currentUserId?hn.channelContainer.remove(a,function(e){e?_e.throw(e):hn.broadcast.remove([a])}):hn.channelContainer.upsert(a,function(e,n){e?_e.throw(e):hn.broadcast.update([n])});break;case"onUserDeclinedInvitation":Se.event(o,t[0].url);var s=t[0];t[2].userId===c.currentUserId?hn.channelContainer.remove(s,function(e){e?_e.throw(e):hn.broadcast.remove([s])}):hn.channelContainer.upsert(s,function(e,n){e?_e.throw(e):hn.broadcast.update([n])});break;case"onChannelDeleted":Se.event(o,t[0]),hn.channelContainer.getItem(t[0],function(e,n){e?_e.throw(e):n&&hn.channelContainer.remove(n,function(e){e?_e.throw(e):hn.broadcast.remove([n])})})}}}),u.addChannelHandler(ln,n)),hn}return c(r,[{key:"syncChangeLog",value:function(o,u){var c,l=this;this.isFetchingChangeLog?u(_e.create(_e.Type.ERROR_DUPLICATED_CHANGELOG_SYNC)):(this.isFetchingChangeLog=!0,Se.call("channel syncChangeLog()"),c="".concat(cn),Ee.get(c).then(function(e){var n="getMyGroupChannelChangeLogsByToken",t=[];t.push([]),t.push(!0),e?(n="getMyGroupChannelChangeLogsByToken",t.unshift(e)):(n="getMyGroupChannelChangeLogsByTimestamp",t.unshift((new Date).getTime()-100)),Se.call(n),(e=l.sb)[n].apply(e,t.concat([function(s,e){var n,t;l.sb.getErrorFirstCallback()&&(n=s,s=e,e=n),e?l.isFetchingChangeLog=!1:(Se.sync("updated",s.updatedChannels&&0<s.updatedChannels.length?"\n"+s.updatedChannels.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n"):[]),Se.sync("deleted",s.deletedChannelUrls),t=[],s.updatedChannels.forEach(function(n){t.push(new Promise(function(a,s){hn.channelContainer.getItem(n.url,function(e,i){e?s(e):hn.channelContainer.upsert(n,function(e,n){var t,r;e?s(e):(r=!i||!i.isEqual(n),t=(!i||i.hiddenState===l.sb.GroupChannel.HiddenState.UNHIDDEN)&&n.hiddenState!==l.sb.GroupChannel.HiddenState.UNHIDDEN,e=(!i||i.hiddenState!==l.sb.GroupChannel.HiddenState.UNHIDDEN)&&n.hiddenState===l.sb.GroupChannel.HiddenState.UNHIDDEN,r=r?"update":"noop",t?r="hide":e&&(r="unhide"),a({action:r,channel:n}))})})}))}),s.deletedChannelUrls.forEach(function(e){t.push(new Promise(function(t,r){hn.channelContainer.getItem(e,function(e,n){e?r(e):n&&hn.channelContainer.remove(n,function(e){e?r(e):t({action:"remove",channel:n})})})}))}),Promise.all(t).then(function(e){for(var n=[],t=[],r=[],i=[],a=0;a<e.length;a++)switch(e[a].action){case"update":n.push(e[a].channel);break;case"remove":t.push(e[a].channel);break;case"hide":r.push(e[a].channel);break;case"unhide":i.push(e[a].channel)}0<n.length&&hn.broadcast.upsert(n,null,{isChangeLogChannel:!0}),0<t.length&&hn.broadcast.remove(t),0<r.length&&hn.broadcast.hide(r,null,{isChangeLogChannel:!0}),0<i.length&&hn.broadcast.unhide(i,null,{isChangeLogChannel:!0}),Ee.set(c,s.token).then(function(){s.hasMore?l.syncChangeLog(o,u):(l.isFetchingChangeLog=!1,u())}).catch(function(e){l.isFetchingChangeLog=!1,u(e)})}).catch(function(e){return u(e)}))}]))}).catch(function(e){l.isFetchingChangeLog=!1,u(e)}))}},{key:"start",value:function(){hn.broadcast.resume()}},{key:"stop",value:function(){hn.broadcast.pause()}},{key:"clearCache",value:function(t){hn.channelSyncByFilter={},hn.changeLogSync=null,hn.channelContainer.clear(function(){hn.queryContainer.clear(function(){Ee.getKeys().then(function(e){var n=[];e.forEach(function(e){e.startsWith(cn)&&n.push(Ee.remove(e))}),Promise.all(n).then(function(){return t()}).catch(function(e){Se.error(e),t(e)})}).catch(function(e){return t(e)})})})}},{key:"reset",value:function(e){hn?(hn.broadcast.clear(),hn.clearCache(e)):e(null)}}],[{key:"getInstance",value:function(){return hn}},{key:"clear",value:function(){hn&&hn.sb&&(Se.message("ChannelManager is cleared"),hn.channelSyncByFilter={},hn.changeLogSync=null,hn.broadcast.clearCollection(),hn.sb.removeChannelHandler(ln),hn=null)}}]),r}(),dn=function(){function i(e){l(this,i),this.worker=e,this.state=i.State.PAUSED,this.isLoading=!1,this.shared=0,this.retry=0,this.retryLimit=3,this.subscribes={}}return c(i,[{key:"start",value:function(t,e){var r=this;!(1<arguments.length&&void 0!==e&&e)&&this.state===i.State.END||this.isLoading||(this.isLoading=!0,this.state=i.State.RUNNING,this.worker(t,function(e,n){Se.sync("background sync result: err=",e,"res=",n),r.isRunning&&(e?r.retry<r.retryLimit?(r.retry++,setTimeout(function(){return r.start(t)},500)):r.state=i.State.PAUSED:(r.retry=0,r.flush(e,n),n.hasMore?setTimeout(function(){r.isRunning&&r.start(n.nextTs)},100):r.state=i.State.END)),r.isLoading=!1}))}},{key:"pause",value:function(){this.isLoading=!1,this.state=i.State.PAUSED}},{key:"end",value:function(){this.isLoading=!1,this.state=i.State.END}},{key:"flush",value:function(e,n){var t,r=0<arguments.length&&void 0!==e?e:null,i=1<arguments.length?n:void 0;for(t in Se.sync("background sync flush: ".concat(Object.keys(this.subscribes).length," subscribes")),this.subscribes)this.subscribes[t](r,i);this.subscribes={}}},{key:"subscribe",value:function(e,n){return!this.subscribes[e]&&(this.subscribes[e]=n,!0)}},{key:"unsubscribeAll",value:function(){this.subscribes={}}},{key:"isRunning",get:function(){return this.state===i.State.RUNNING}},{key:"isEnd",get:function(){return this.state===i.State.END}}],[{key:"State",get:function(){return{RUNNING:"running",PAUSED:"paused",END:"end"}}}]),i}(),gn="channel-collection-handler",vn=new Z,yn=new Z,mn=function(s){var o=fn.getInstance();if(o){var u=s.query,e=u.filterKey;return o.channelSyncByFilter[e]||(o.channelSyncByFilter[e]=new dn(function(e,a){Se.call("channel syncChannel()",u.filterKey,u.hasNext,u._token),u.hasNext?(u.limit=100,u.next(function(i,e){var n;o.sb.getErrorFirstCallback()&&(e=(n=[i,e])[0],i=n[1]),Se.sync("channel",e,i&&0<i.length?"\n"+i.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n"):""),e?a(e):function(){for(var n=vn.get(s),t=0,r=null,e=0;e<i.length;e++)o.channelContainer.insert(i[e],function(e){r=r||e,++t===i.length&&(r?a(r):((e=n.findChannelEdges(i)).end&&(u.savepoint=e.end+""),o.queryContainer.upsert(u,function(e){e?a(e):a(null,{count:i.length,nextTs:0,hasMore:u.hasNext})})))});0===i.length&&a(null,{count:0,nextTs:0,hasMore:!1})}()})):a(null,{count:0,nextTs:0,hasMore:!1})})),o.channelSyncByFilter[e]}return null},pn=function(e){var t,r=fn.getInstance();return r?(r.changeLogSync||(t=e.query,r.changeLogSync=new dn(function(e,n){r.syncChangeLog(t,function(e){n(e,{count:0,nextTs:0,hasMore:!1})})})),r.changeLogSync):null},kn=function(){function e(){l(this,e),this.collection=null,this.channels=[],this.mutex=new O,this.viewOffset=null}return c(e,[{key:"attachCollection",value:function(e){this.collection=e}},{key:"compareWithChannel",value:function(e,n){var t="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":t="createdAt";break;case"channel_name_alphabetical":t="name"}return this.compareWithOffset(e,n[t])}},{key:"compareWithOffset",value:function(e,n){switch(this.collection.query.order){case"latest_last_message":return e.lastMessageUpdatedAt-n;case"chronological":return e.createdAt-n;case"channel_name_alphabetical":return n.localeCompare(e.name);default:return e.lastMessageUpdatedAt-n}}},{key:"isAbove",value:function(e,n){return 0<this.compareWithOffset(e,n)}},{key:"isBelow",value:function(e,n){return this.compareWithOffset(e,n)<0}},{key:"findChannelEdges",value:function(e){var n="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":n="createdAt";break;case"channel_name_alphabetical":n="name"}var t,r={start:null,end:null};for(t in e)r.start&&!this.isAbove(e[t],r.start)||(r.start=e[t][n]),r.end&&!this.isBelow(e[t],r.end)||(r.end=e[t][n]);return r}},{key:"refreshViewOffset",value:function(){var e=this.findChannelEdges(this.channels);this.viewOffset=e.end}},{key:"addViewItems",value:function(f,e){var d=this,g=1<arguments.length&&void 0!==e?e:{},v=[],y=[],m=[],p=[],k=yn.get(this.collection);this.mutex.lock(function(e){for(var n in f){var t,r=f[n],i=Ue(r,d.channels),a=function(e,n,t){var r=2<arguments.length&&void 0!==t?t:[],i=null,a=function(e,n){return n<e};switch(n.order){case"latest_last_message":i="lastMessageUpdatedAt";break;case"chronological":i="createdAt";break;case"channel_name_alphabetical":i="name",a=function(e,n){return e.localeCompare(n)<0};break;default:i="lastMessageUpdatedAt"}var s=Ue(e,r);s<0&&(s=r.length);for(var o=0;o<r.length;o++){var u=r[o];if(e[i]===u[i]&&e.url===u.url){s=o;break}if(a(e[i],u[i])){s=o;break}}return s}(r,d.collection.query,d.channels),s=!1;g.isEventChannel&&(d.viewOffset?d.isBelow(r,d.viewOffset)&&(s=!0):(t=mn(d.collection),o=pn(d.collection),t.state!==dn.State.RUNNING&&o.state!==dn.State.RUNNING||!d.collection.query.hasNext||(s=!0)));var o=i<0?Je.INSERT:Je.UPDATE;switch(i<0?s||(a<d.channels.length?d.channels.splice(a,0,r):d.channels.push(r)):i!==a?a<d.channels.length?(o=Je.MOVE,d.channels.splice(i,1),i<a?d.channels.splice(a-1,0,r):d.channels.splice(a,0,r)):(o=Je.REMOVE,d.channels.splice(i,1)):d.channels[i]=r,o){case Je.INSERT:s||v.push(r);break;case Je.UPDATE:y.push(r);break;case Je.MOVE:m.push(r);break;case Je.REMOVE:p.push(r)}}if(d.refreshViewOffset(),0<v.length)for(var u in Se.view("channel",Je.INSERT,"\n"+v.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),k)k[u].onChannelEvent(Je.INSERT,v);if(0<y.length)for(var c in Se.view("channel",Je.UPDATE,"\n"+y.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),k)k[c].onChannelEvent(Je.UPDATE,y);if(0<m.length)for(var l in Se.view("channel",Je.MOVE,"\n"+m.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),k)k[l].onChannelEvent(Je.MOVE,m);if(0<p.length)for(var h in Se.view("channel",Je.REMOVE,"\n"+p.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),k)k[h].onChannelEvent(Je.REMOVE,p);e()})}},{key:"removeViewItems",value:function(s){var o=this,u=yn.get(this.collection);this.mutex.lock(function(e){var n,t=[];for(n in s){var r=s[n],i=o.channels.map(function(e){return e.url}).indexOf(r.url);0<=i&&(o.channels.splice(i,1),t.push(r))}if(0<t.length)for(var a in Se.view("channel",Je.REMOVE,"\n"+t.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),u)u[a].onChannelEvent(Je.REMOVE,t);e()})}},{key:"clearViewItem",value:function(){this.channels=[];var r=yn.get(this.collection);this.mutex.lock(function(e){var n,t=Je.CLEAR;for(n in Se.view("channel",t),r)r[n].onChannelEvent(t);e()})}}]),e}(),In=function(){function n(t){var r=this;l(this,n);var e=new kn,i=fn.getInstance();if(!i)return null;this.collectionId=Fe(),this.sendBird=i.sb,this.type="MyGroupChannelListQuery",this.limit=t.limit,this.query=t,this.query.filterKey=i.queryContainer.createFilterKey(this.query),this._isLoading=!1,e.attachCollection(this),i.broadcast.addCollection(this,e),vn.set(this,e),yn.set(this,{}),mn(this).shared++,pn(this).shared++,i.queryContainer.getItem(this.query.filterKey,function(e,n){e?_e.throw(e):(n&&(r.query._token=n._token,r.query.hasNext=n.hasNext,r.query.savepoint=n.savepoint,r.query.updatedAt=n.updatedAt),i.queryContainer.upsert(t,function(e,n){e?_e.throw(e):(r.query=n,r._resume(),Se.message("channel collection ".concat(r.collectionId," is created.")))}))})}return c(n,[{key:"_pause",value:function(){Se.call("channel sync pause",this.collectionId);var e=mn(this),n=pn(this);e&&e.pause(),n&&n.pause()}},{key:"_resume",value:function(){Se.call("channel sync resume",this.collectionId);var e=mn(this),n=pn(this);e&&e.start(),n&&n.start()}},{key:"fetch",value:function(e){var h=this;if(!this._isLoading)return this._isLoading=!0,xe(function(t){Se.call("fetch()");var i=vn.get(h),e=h.sendBird,n=jn.getInstance(),a=fn.getInstance(),s={ownerUserId:n.currentUserId};if(h.query.includeEmpty||(s.lastMessage={"!=":null}),h.query.nicknameContainsFilter&&(s.members={"/where":function(e){for(var n in e)if(0<=e[n].nickname.indexOf(h.query.nicknameContainsFilter))return!0;return!1}}),h.query.userIdsFilter&&Array.isArray(h.query.userIdsFilter)&&0<h.query.userIdsFilter.length&&(s.members={"/where":function(e){var t=e.map(function(e){return e.userId});return h.query.userIdsFilterExactMatch?t.length===h.query.userIdsFilter.length&&h.query.userIdsFilter.every(function(e){return 0<=t.indexOf(e)}):"AND"===h.query.queryType?h.query.userIdsFilter.every(function(e){return 0<=t.indexOf(e)}):"OR"===h.query.queryType&&h.query.userIdsFilter.reduce(function(e,n){return e||0<=t.indexOf(n)},!1)}}),h.query.channelNameContainsFilter&&(s.name={"/regex":new RegExp(h.query.channelNameContainsFilter)}),0<h.query.channelUrlsFilter.length&&(s.url={"/in":h.query.channelUrlsFilter}),h.query.memberStateFilter!==e.GroupChannel.MemberStateFilter.ALL)switch(h.query.memberStateFilter){case e.GroupChannel.MemberStateFilter.JOINED:s.myMemberState="joined";break;case e.GroupChannel.MemberStateFilter.INVITED:case e.GroupChannel.MemberStateFilter.INVITED_BY_FRIEND:case e.GroupChannel.MemberStateFilter.INVITED_BY_NON_FRIEND:s.myMemberState="invited"}if("string"==typeof h.query.customTypeFilter&&h.query.customTypeFilter&&(s.customType=h.query.customTypeFilter),Array.isArray(h.query.customTypesFilter)&&0<h.query.customTypesFilter.length&&(s.customType={"/in":h.query.customTypesFilter}),"string"==typeof h.query.customTypeStartsWithFilter&&h.query.customTypeStartsWithFilter&&(s.customType={"/regex":new RegExp("^".concat(h.query.customTypeStartsWithFilter))}),h.query.superChannelFilter!==e.GroupChannel.SuperChannelFilter.ALL)switch(h.query.superChannelFilter){case e.GroupChannel.SuperChannelFilter.SUPER:s.isSuper=!0;break;case e.GroupChannel.SuperChannelFilter.NONSUPER:s.isSuper=!1}if(h.query.publicChannelFilter!==e.GroupChannel.PublicChannelFilter.ALL)switch(h.query.publicChannelFilter){case e.GroupChannel.PublicChannelFilter.PUBLIC:s.isPublic=!0;break;case e.GroupChannel.PublicChannelFilter.PRIVATE:s.isPublic=!1}if(h.query.unreadChannelFilter!==e.GroupChannel.UnreadChannelFilter.ALL&&h.query.unreadChannelFilter===e.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE&&(s.unreadMessageCount={">":0}),"all"!=h.query.hiddenChannelFilter)switch(h.query.hiddenChannelFilter){case e.GroupChannel.HiddenChannelFilter.UNHIDDEN:s.hiddenState=e.GroupChannel.HiddenState.UNHIDDEN;break;case e.GroupChannel.HiddenChannelFilter.HIDDEN:s.hiddenState={"/in":[e.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE,e.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE]};break;case e.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:s.hiddenState=e.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE;break;case e.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:s.hiddenState=e.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE}var o=null,u=!0;switch(h.query.order){case"latest_last_message":!h.query.hasNext&&h.query.savepoint&&(s.lastMessageUpdatedAt={">=":parseInt(h.query.savepoint)}),o={ownerUserId:1,lastMessageUpdatedAt:-1};break;case"chronological":!h.query.hasNext&&h.query.savepoint&&(s.createdAt={">=":parseInt(h.query.savepoint)}),o={ownerUserId:1,createdAt:-1};break;case"channel_name_alphabetical":!h.query.hasNext&&h.query.savepoint&&(s.name={"<=":h.query.savepoint}),u=!(o={ownerUserId:1,name:1});break;default:!h.query.hasNext&&h.query.savepoint&&(s.lastMessageUpdatedAt={">=":parseInt(h.query.savepoint)}),o={ownerUserId:1,lastMessageUpdatedAt:-1}}function r(t,r){a.channelContainer.query(s,{offset:i.channels.length,limit:t,index:o,desc:u},function(e,n){e?(h._isLoading=!1,r(e)):(h._isLoading=!1,n.sort(function(e,n){return 0<i.compareWithChannel(e,n)}),0<n.length&&i.addViewItems(n),n.length<t&&l(t-n.length),r(null,n))})}var c=mn(h),l=function(n){c.state!==dn.State.END&&(Se.sync("subscribe channel",h.collectionId),c.subscribe(h.collectionId,function(e){e?Se.error(e):(Se.sync("flush channel"),r(n,function(e){e&&Se.error(e)}))}))};r(h.limit,function(e,n){Se.cache("fetch channel",e,n.map(function(e){return e.url})),t(e)}),c.state===dn.State.PAUSED&&h._resume()},e);Se.error("fetch() is loading"),e(_e.create(_e.Type.ERROR_DUPLICATED_FETCH))}},{key:"remove",value:function(){fn.getInstance().broadcast.removeCollection(this);var e=mn(this),n=pn(this);e&&(e.shared--,0===e.shared&&e.pause()),n&&(n.shared--,0===n.shared&&n.pause())}},{key:"setCollectionHandler",value:function(e){var n=yn.get(this);e instanceof We&&(n[gn]=e)}},{key:"removeCollectionHandler",value:function(){var e=yn.get(this);e[gn]&&delete e[gn]}},{key:"channels",get:function(){return vn.get(this).channels}}],[{key:"CollectionHandler",get:function(){return We}},{key:"Action",get:function(){return Je}}]),n}();"undefined"==typeof Promise&&(Promise=e);var bn=new Z,En=new Z,Cn=new Z,wn=new Z,Mn=new Z,An="message-collection-handler",Sn=300,_n=50,On=100,Tn=100,Rn=50,Un=function(){function e(){l(this,e),this.collection=null,this.messages=[],this.prevTempMessages=[],this.nextTempMessages=[],this.unsentMessages=[],bn.set(this,{}),this.mutex=new O,this.currentChunk=null,this.viewRange={start:0,end:0}}return c(e,[{key:"attachCollection",value:function(e){this.collection=e}},{key:"channelWasRemoved",value:function(e){var n,t=Mn.get(this.collection);for(n in t)t[n].onChannelRemoved(e)}},{key:"channelWasUpdated",value:function(e){var n,t=Mn.get(this.collection);for(n in t)t[n].onChannelUpdated(e)}},{key:"addViewItems",value:function(w,e){var M=this,A=1<arguments.length&&void 0!==e?e:{},S=Mn.get(this.collection),_=bn.get(this),O=wn.get(this.collection),T=[],R=[],U=[],D=[],N=[],x=[],F=[],P=[],L=[];this.mutex.lock(function(e){for(var n in w){var t=w[n];if(t.messageId){var r=!0,i=!1;A.isEventMessage&&(a=O.state===dn.State.END,u=!M.currentChunk||M.currentChunk.endAt<=M.viewRange.end,s=0===M.viewRange.end,i=!0,r=a&&u||!M.currentChunk||s);var a=M.collection.sendBird.currentUser?M.collection.channel.getReadReceipt(t):_[t.messageId]||0;if(_[t.messageId]||(_[t.messageId]=a),r){var s,o=De(t,M.messages),u=function(e,n){for(var t=1<arguments.length&&void 0!==n?n:[],r=t.length,i=0;i<t.length;i++)if(t[i].createdAt>=e.createdAt){r=i;break}return r}(t,M.messages);if(0<=o&&M.messages[o].isEqual(t)&&_[t.messageId]===a)continue;_[t.messageId]=a,M.viewRange.start=0<M.viewRange.start?Math.min(M.viewRange.start,t.createdAt):t.createdAt,M.viewRange.end=0<M.viewRange.end?Math.max(M.viewRange.end,t.createdAt):t.createdAt,o<0?(0<=(s=De(t,M.unsentMessages))&&(a=!(r=M.unsentMessages[s]).isUserMessage()||"pending"===r.sendingStatus,M.unsentMessages.splice(s,1),(a?x:L).push(r)),M.messages.splice(u,0,t),i&&M.nextTempMessages.push(t),T.push(t)):(M.messages[o]=t,R.push(t))}A.isEventMessage&&t.sender&&t.sender.userId!==jn.getInstance().currentUserId&&D.push(t);i=M.messages.length,o=[];i>jn.syncManagerOptions.messageCollectionCapacity&&(o="next"===A.direction?(c=i-jn.syncManagerOptions.messageCollectionCapacity,M.messages.splice(0,c)):M.messages.splice(jn.syncManagerOptions.messageCollectionCapacity),U.push.apply(U,q(o)))}else{var i=!t.isUserMessage()||"pending"===t.sendingStatus,c=De(t,M.unsentMessages);c<0?De(t,M.messages)<0&&((i?N:F).push(t),M.unsentMessages.push(t)):(o=M.unsentMessages[c]).isUserMessage()?"pending"===o.sendingStatus?i||(x.push(o),F.push(t),M.unsentMessages[c]=t):(P.push(t),M.unsentMessages[c]=t):M.unsentMessages[c]=t}}if(0<U.length)for(var l in Se.view("message",Xe.REMOVE,U.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),S)S[l].onSucceededMessageEvent(U,Xe.REMOVE),S[l].onMessageEvent(Xe.REMOVE,U);if(0<T.length)for(var h in Se.view("message",Xe.INSERT,T.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),S)S[h].onSucceededMessageEvent(T,Xe.INSERT),S[h].onMessageEvent(Xe.INSERT,T);if(0<R.length)for(var f in Se.view("message",Xe.UPDATE,R.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),S)S[f].onSucceededMessageEvent(R,Xe.UPDATE),S[f].onMessageEvent(Xe.UPDATE,R);if(0<x.length)for(var d in Se.view("pending message",Xe.REMOVE,x.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),S)S[d].onPendingMessageEvent(x,Xe.REMOVE),S[d].onMessageEvent(Xe.REMOVE,x);if(0<N.length)for(var g in Se.view("pending message",Xe.INSERT,N.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),S)S[g].onPendingMessageEvent(N,Xe.INSERT),S[g].onMessageEvent(Xe.INSERT,N);if(0<L.length){Se.view("failed message",Xe.REMOVE,L.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt}));var v,y=Ye.REMOVE_RESEND_SUCCEEDED;for(v in S)S[v].onFailedMessageEvent(L,Xe.REMOVE,y)}if(0<P.length){Se.view("failed message",Xe.UPDATE,P.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt}));var m,p=Ye.UPDATE_RESEND_FAILED;for(m in S)S[m].onFailedMessageEvent(P,Xe.UPDATE,p)}if(0<F.length){Se.view("failed message",Xe.INSERT,F.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt}));var k,I=Ye.NONE;for(k in S)S[k].onFailedMessageEvent(F,Xe.INSERT,I)}if(0<D.length)for(var b=0;b<D.length;b++){var E,C=D[b];for(E in Se.view("new message",C.reqId,C.messageId,C.createdAt),S)S[E].onNewMessage(C)}e()})}},{key:"removeViewItems",value:function(k,e){var I=this,b=1<arguments.length&&void 0!==e?e:{isRequestId:!1};this.mutex.lock(function(e){var n=!!b.hasOwnProperty("isRequestId")&&b.isRequestId,t=Mn.get(I.collection);if(n){for(var r=[],i=[],a=0;a<k.length;a++)for(var s=k[a],o=0;o<I.unsentMessages.length;o++)if(s===I.unsentMessages[o].reqId){var u=I.unsentMessages[o];if(u.isUserMessage())switch(u.sendingStatus){case"pending":r.push(u);break;case"failed":i.push(u)}else u.isFileMessage()&&r.push(u);I.unsentMessages.splice(o,1);break}if(0<r.length)for(var c in Se.view("pending message",Xe.REMOVE,r.map(function(e){return e.reqId})),t)t[c].onPendingMessageEvent(r,Xe.REMOVE),t[c].onMessageEvent(Xe.REMOVE,r);if(0<i.length){Se.view("failed message",Xe.REMOVE,i.map(function(e){return e.reqId}));var l,h=b.hasOwnProperty("reason")?b.reason:Ye.REMOVE_UNKNOWN;for(l in t)t[l].onFailedMessageEvent(i,Xe.REMOVE,h)}}else{for(var f=bn.get(I),d=[],g=0;g<k.length;g++)for(var v=k[g],y=0;y<I.messages.length;y++)if(v===I.messages[y].messageId){"number"==typeof f[v]&&delete f[v];var m=I.messages.splice(y,1);d.push.apply(d,q(m));break}if(I.viewRange.start=0<I.messages.length?I.messages[0].createdAt:0,I.viewRange.end=0<I.messages.length?I.messages[I.messages.length-1].createdAt:0,0<d.length)for(var p in Se.view("message",Xe.REMOVE,d.map(function(e){return e.messageId})),t)t[p].onSucceededMessageEvent(d,Xe.REMOVE),t[p].onMessageEvent(Xe.REMOVE,d)}e()})}},{key:"clearUnsentMessages",value:function(){var a=this;this.mutex.lock(function(e){var n,t=a.unsentMessages,r=Mn.get(a.collection);for(n in a.unsentMessages=[],Se.view("message",Xe.REMOVE,"unsent messages"),r){r[n].onPendingMessageEvent([],Xe.CLEAR);var i=Ye.NONE;r[n].onFailedMessageEvent([],Xe.CLEAR,i),r[n].onMessageEvent(Xe.REMOVE,t)}e()})}},{key:"clearViewItem",value:function(){var r=this;this.mutex.lock(function(e){r.currentChunk=null,r.messages=[],bn.set(r,{}),r.viewRange.start=0,r.viewRange.end=0;var n,t=Mn.get(r.collection);for(n in Se.view("message",Xe.CLEAR),t)t[n].onSucceededMessageEvent([],Xe.CLEAR),t[n].onMessageEvent(Xe.CLEAR);e()})}},{key:"updateCurrentChunk",value:function(e){e?this.currentChunk&&this.currentChunk.isSame(e)||(this.currentChunk=Ge.createFromJson(e)):this.currentChunk=e}}]),e}(),Dn=function(){function o(r){var d=this,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:(new Date).getTime();l(this,o);var g=sn.getInstance();if(!g)return null;if(this.collectionId=Fe(),this.sendBird=g.sb,this.channel=r,this.limit=Rn,this.filter=Ge.getDefaultFilter(),e&&"object"===f(e)&&0<Object.keys(e).length)for(var t in e)this.filter.hasOwnProperty(t)&&(this.filter[t]=e[t]);this.viewpoint=n,this._isLoading={prev:!1,next:!1},nn.getInstance().createQueue(this.channel.url);var v=new Un;v.attachCollection(this),En.set(this,v),Cn.set(this,null),wn.set(this,null),Mn.set(this,{}),g.broadcast.addCollection(this,v);function i(l,t,h){Se.sync("message synchronize() begin",l,t);var e=null,f=0,n=[t];switch(l){case"prev":e="getPreviousMessagesByTimestamp",f=On,n.push(!0),n.push(On);break;case"next":e="getNextMessagesByTimestamp",f=Tn,n.push(!0),n.push(Tn);break;case"prevnext":e="getPreviousAndNextMessagesByTimestamp",f=2*_n,n.push(_n),n.push(_n)}n.push(!1),n.push(d.filter.messageType||""),n.push(d.filter.customType||""),n.push(d.filter.senderUserIdsFilter||[]),n.push(d.filter.includeMetaArray||!0),r[e].apply(r,n.concat([function(c,e){var n;g.sb.getErrorFirstCallback()&&(e=(n=[c,e])[0],c=n[1]),e?(d._pause(),h(e)):(Se.sync("message synchronize() end",l,t,c.map(function(e){return e.messageId})),a.lock(function(t){var r,i=[],a={startAt:Number.MAX_SAFE_INTEGER,endAt:0},s=c.length>=f,o=[],n=p(c);try{for(n.s();!(r=n.n()).done;)!function(){var e=r.value;e.isVisible=!0;var n=p(d.unsentMessages);try{for(n.s();!(t=n.n()).done;){var t=t.value;if("pending"===t.sendingStatus&&t.reqId===e.reqId){o.push(e);break}}}catch(e){n.e(e)}finally{n.f()}i.push(new Promise(function(n,t){g.messageContainer.upsert(e,function(e){return e?t(e):n()})})),a.startAt=Math.min(a.startAt,e.createdAt),a.endAt=Math.max(a.endAt,e.createdAt)}()}catch(e){n.e(e)}finally{n.f()}v.currentChunk&&v.currentChunk.isOverlap(a)||(v.currentChunk=new Ge(d.channel.url,d.filter),Se.message("chunk is created",v.currentChunk.startAt,v.currentChunk.endAt)),v.currentChunk.extendWithChunk(a);var u=v.currentChunk;Se.message("currentChunk is extended",u.startAt,u.endAt),g.chunkContainer.mergePreviousChunkOverlap(u,function(e){e?(t(),h(e)):(Se.message("currentChunk merged previous chunks",u.startAt,u.endAt),Promise.all(i).then(function(){0<o.length&&v.addViewItems(o);var e={start:u.startAt,end:u.endAt};switch(l){case"prevnext":s||(e.start=0,e.end=Number.MAX_SAFE_INTEGER);break;case"prev":s||(e.start=0,m.isEnd&&(e.end=Number.MAX_SAFE_INTEGER));break;case"next":s||(e.end=Number.MAX_SAFE_INTEGER,y.isEnd&&(e.start=0))}g.messageContainer.resolvePendingMessagesAsFailed(d.channel.url,e.start,e.end,function(e,n){e||0<n.length&&v.addViewItems(n),t(),h(null,{count:c.length,nextTs:"prev"===l?u.startAt:u.endAt,hasMore:s})})}).catch(function(e){t(),h(e)}))})}))}]))}var a=new O,y=new dn(function(e,n){return i("prev",e,n)});y.shared++,Cn.set(this,y);var m=new dn(function(e,n){return i("next",e,n)});m.shared++,wn.set(this,m);n=this.sendBird.getLastConnectedAt();0<n&&g.messageContainer.pullPendingResolveBottom(this.channel.url,n,function(e){}),g.chunkContainer.getChunkByTimestamp(this.channel.url,this.filter,this.viewpoint,function(e,n){e||(n&&(v.currentChunk=n),v.currentChunk?d._resume():i("prevnext",d.viewpoint,function(e,n){e||setTimeout(function(){y.flush(e,n),m.flush(e,n),n.count<_n?(y.end(),m.end()):d._resume()},Sn)}),Se.message("message collection ".concat(d.collectionId," is created.")))}),Object.defineProperty(this,"messageCount",{get:function(){try{return v.messages.length}catch(e){return 0}}})}return c(o,[{key:"_pause",value:function(){Se.call("message sync pause",this.collectionId);var e=En.get(this),n=Cn.get(this),t=wn.get(this);n&&n.pause(),t&&t.pause(),e.currentChunk=null}},{key:"_resume",value:function(t){var r=this;Se.call("message sync resume",this.collectionId);var e=sn.getInstance(),i=Cn.get(this),a=wn.get(this);i&&i.isRunning&&(i.pause(),i.unsubscribeAll()),a&&a.isRunning&&(a.pause(),a.unsubscribeAll()),e.syncChangeLog(this.channel,function(){var e,n=En.get(r);i&&(e=n.currentChunk?n.currentChunk.startAt:r.viewpoint,i.start(e)),a&&(n=n.currentChunk?n.currentChunk.endAt:r.viewpoint,a.start(n,!0),t&&a.subscribe(r.collectionId+"_autoresendqueue",t))})}},{key:"fetch",value:function(e,n){return this.fetchSucceededMessages(e,n)}},{key:"fetchSucceededMessages",value:function(g,e){var v=this,a=sn.getInstance(),y=En.get(this);return this._isLoading[g]?xe(function(e){return e(_e.create(_e.Type.ERROR_DUPLICATED_FETCH))},e):(this._isLoading[g]=!0,xe(function(c){Se.call("fetchSucceededMessages()",g);var t=null,l=v.viewpoint,h=v.limit,r=!1,e=l,f=null,i=null;switch(g){case"prev":t=Cn.get(v),0<y.viewRange.start&&(l=y.viewRange.start),y.currentChunk&&(e=Math.max(y.currentChunk.startAt,l)),f=y.prevTempMessages,i=a.messageContainer.loadPreviousSucceededMessages,r=!0;break;case"next":t=wn.get(v),0<y.viewRange.end&&(l=y.viewRange.end),y.currentChunk&&(e=Math.min(y.currentChunk.endAt,l)),f=y.nextTempMessages,i=a.messageContainer.loadNextSucceededMessages;break;default:return void c(_e.create(_e.Type.ERROR_INVALID_PARAMETER))}function d(n,u){Se.message("waiting for synchronization...");var c=!1;i(v.channel.url,v.filter,n,{limit:h,desc:r},function(e,n){e?(c=!0,v._isLoading[g]=!1,u(e)):(Se.cache("temp message",g,n.map(function(e){return e.messageId})),(0<n.length||t.state===dn.State.END)&&(c=!0,f.push.apply(f,q(n)),y.addViewItems(n,{direction:g}),v._isLoading[g]=!1,u(null)))});var l=e;Se.sync("subscribe message",v.collectionId,g,n),t.subscribe(v.collectionId,function(e){e?(Se.error(e),c||(v._isLoading[g]=!1,u(e))):(Se.sync("flush message",g,n),a.chunkContainer.getChunkByTimestamp(v.channel.url,v.filter,n,function(e,n){var o;e?(Se.error(e),c||(v._isLoading[g]=!1,u(e))):(n&&(y.currentChunk=n),y.currentChunk?(o=y.currentChunk,i(v.channel.url,v.filter,l,{limit:h,desc:r},function(e,n){if(e)Se.error(e),c||(v._isLoading[g]=!1,u(e));else{Se.cache("flush message",g,l,n.map(function(e){return e.messageId}));var t,r,i,a=[],s=[];for(t in n)!o.containsMessage(n[t])||((r=y.messages.map(function(e){return e.messageId}).indexOf(n[t].messageId))<0||!y.messages[r].isEqual(n[t]))&&a.push(n[t]);for(i in f)y.messages.map(function(e){return e.messageId}).indexOf(f[i].messageId)<0&&s.push(f[i]);for(;0<f.length;)f.pop();0<s.length&&y.removeViewItems(s.map(function(e){return e.messageId})),0<a.length&&y.addViewItems(a,{direction:g}),c||(v._isLoading[g]=!1,u(null))}})):(Se.error(e),c||(v._isLoading[g]=!1,u(e))))}))})}a.chunkContainer.getChunkByTimestamp(v.channel.url,v.filter,l,function(e,n){var u;e?(v._isLoading[g]=!1,c(e)):(n&&(y.currentChunk=n),y.currentChunk?(u=y.currentChunk,Se.message("chunk is selected",u),i(v.channel.url,v.filter,l,{limit:h,desc:r},function(e,n){if(e)v._isLoading[g]=!1,c(e);else{var t=[],r=[];Se.cache("fetch message",g,l,n.map(function(e){return e.messageId}));var i,a,s=!1;for(i in n)u.containsMessage(n[i])&&(s=!0,((a=y.messages.map(function(e){return e.messageId}).indexOf(n[i].messageId))<0||!y.messages[a].isEqual(n[i]))&&t.push(n[i]));if(!s){for(var o in f)y.messages.map(function(e){return e.messageId}).indexOf(f[o].messageId)<0&&r.push(f[o]);for(;0<f.length;)f.pop()}0<t.length&&y.addViewItems(t,{direction:g}),0<r.length&&y.removeViewItems(r.map(function(e){return e.messageId})),n.length<h?(h-=n.length,d(l,c)):(v._isLoading[g]=!1,c(null))}})):d(l,c))}),t.state===dn.State.PAUSED&&v._resume()},e))}},{key:"fetchFailedMessages",value:function(e){var r=this;return xe(function(t){Se.call("fetchFailedMessages()"),nn.getInstance().loadFailedMessages(r.channel.url,r.filter,function(e,n){e||(Se.cache("fetch failed message",n.map(function(e){return e.reqId})),En.get(r).addViewItems(n)),t(e)})},e)}},{key:"fetchPendingMessages",value:function(e){var r=this,n=sn.getInstance();return xe(function(t){Se.call("fetchPendingMessages()"),n.messageContainer.loadPendingMessages(r.channel.url,r.filter,{},function(e,n){e||(Se.cache("fetch pending message",n.map(function(e){return e.reqId})),En.get(r).addViewItems(n)),t(e)})},e)}},{key:"resetViewpointTimestamp",value:function(e){var n=0<arguments.length&&void 0!==e?e:(new Date).getTime();"number"==typeof n&&0<=n?(Se.call("resetViewpointTimestamp()",n),(e=En.get(this)).viewRange.start<=n&&n<=e.viewRange.end?e.currentChunk&&!e.currentChunk.contains(n)&&(e.currentChunk=null):(e.currentChunk=null,e.clearViewItem()),this.viewpoint=n,this._resume()):(Se.error("resetViewpointTimestamp()","ts should be number type and greater than or equal to 0."),_e.throw(_e.create(_e.Type.ERROR_INVALID_PARAMETER)))}},{key:"remove",value:function(){nn.getInstance().removeQueue(this.channel.url),sn.getInstance().broadcast.removeCollection(this),En.get(this).currentChunk=null;var e=Cn.get(this),n=wn.get(this);e&&(e.shared--,0===e.shared&&e.pause()),n&&(n.shared--,0===n.shared&&n.pause())}},{key:"handleSendMessageResponse",value:function(e,n){if(Se.call("handleSendMessageResponse()",e,n),e){var t;if(n)switch(jn.syncManagerOptions.messageResendPolicy){case jn.Options.MessageResendPolicy.NONE:this.deleteMessage(n);break;case jn.Options.MessageResendPolicy.MANUAL:case jn.Options.MessageResendPolicy.AUTOMATIC:n.isUserMessage()&&800110!==e.code?this.appendMessage(n):(t={reason:Ye.REMOVE_UNKNOWN},this.deleteMessage(n,t));break;default:this.deleteMessage(n)}else this.deleteMessage(n),Se.error(e)}else{var r,i=En.get(this),a={reason:Ye.REMOVE_RESEND_SUCCEEDED};for(r in i.unsentMessages)if(i.unsentMessages[r].isIdentical(n)){this.deleteMessage(i.unsentMessages[r],a);break}this.appendMessage(n)}}},{key:"hasMessage",value:function(e){if(e)for(var n=En.get(this),t=0;t<n.succeededMessages.length;t++)if(n.succeededMessages[t].isIdentical(e))return!0;return!1}},{key:"appendMessage",value:function(t){var r,e,i,n;t?(Se.call("appendMessage()",t.messageId),n=jn.getInstance(),r=sn.getInstance(),e=En.get(this),t.messageId?t.sender&&t.sender.userId===n.currentUserId?(t.isVisible=!0,r.messageContainer.upsert(t,function(e,n){e||r.broadcast.upsert([n])}),(i=fn.getInstance()).channelContainer.getItem(t.channelUrl,function(e,n){e?_e.throw(e):n&&(!n.lastMessage||n.lastMessage.createdAt<=t.createdAt)&&(n.lastMessage=t,i.channelContainer.upsert(n,function(e,n){e?_e.throw(e):i.broadcast.upsert([n])}))})):Se.warning("Cannot append message sent by other member."):(n=jn.syncManagerOptions,"failed"===t.sendingStatus?n.messageResendPolicy!==jn.Options.MessageResendPolicy.NONE?nn.getInstance().upsertMessages(this.channel.url,[t]):e.removeViewItems([t]):"pending"===t.sendingStatus&&(e.addViewItems([t]),n=parseInt(this.sendBird.getLastConnectedAt()/1e3),t.pendingResolveTop=e.currentChunk?Math.max(e.currentChunk.endAt,n):n,t.pendingResolveBottom=Number.MAX_SAFE_INTEGER,r.messageContainer.upsert(t,function(e,n){})))):(Se.error("appendMessage()","Message is expected but ".concat(t," is given.")),_e.throw(_e.create(_e.Type.ERROR_INVALID_PARAMETER)))}},{key:"updateMessage",value:function(t){var e,r,n,i;t?(Se.call("updateMessage()",t.messageId),e=jn.getInstance(),r=sn.getInstance(),n=En.get(this),t.sender&&t.sender.userId===e.currentUserId&&(t.messageId?(t.isVisible=!0,r.messageContainer.upsert(t,function(e,n){e||r.broadcast.update([n])}),(i=fn.getInstance()).channelContainer.getItem(t.channelUrl,function(e,n){e?_e.throw(e):n&&n.lastMessage&&n.lastMessage.messageId===t.messageId&&(n.lastMessage=t,i.channelContainer.upsert(n,function(e,n){e?_e.throw(e):i.broadcast.update([n])}))})):n.addViewItems([t]))):(Se.error("updateMessage()","Message is expected but ".concat(t," is given.")),_e.throw(_e.create(_e.Type.ERROR_INVALID_PARAMETER)))}},{key:"deleteMessage",value:function(e,n){var t=1<arguments.length&&void 0!==n?n:{};e?(Se.call("deleteMessage()",e.messageId),n=jn.getInstance(),e.sender&&e.sender.userId===n.currentUserId&&(e.messageId||this.deleteMessageByRequestID(e.reqId,t))):(Se.error("deleteMessage()","Message is expected but ".concat(e," is given.")),_e.throw(_e.create(_e.Type.ERROR_INVALID_PARAMETER)))}},{key:"deleteMessageByRequestID",value:function(e,n){var t,r=1<arguments.length&&void 0!==n?n:{},i=En.get(this),a=p(i.unsentMessages);try{for(a.s();!(t=a.n()).done;){var s=t.value;if(s.reqId===e){switch(s.sendingStatus){case"pending":i.removeViewItems([s.reqId],!0);break;case"failed":nn.getInstance().removeMessages(this.channel.url,[s],r)}break}}}catch(e){a.e(e)}finally{a.f()}}},{key:"setCollectionHandler",value:function(e){var n=Mn.get(this);e instanceof ze&&(n[An]=e)}},{key:"removeCollectionHandler",value:function(){var e=Mn.get(this);e[An]&&delete e[An]}},{key:"messages",get:function(){return this.succeededMessages}},{key:"succeededMessages",get:function(){return En.get(this).messages}},{key:"unsentMessages",get:function(){return En.get(this).unsentMessages}}],[{key:"create",value:function(t,a,s,e){"function"==typeof s&&(e=s,s=(new Date).getTime());var n=fn.getInstance();return xe(function(i){n.channelContainer.getItem(t,function(e,n){var r;e?i(e):n?i(null,new o(n,a,s)):(r=fn.getInstance()).sb.GroupChannel.getChannel(t,function(e,n){var t;r.sb.getErrorFirstCallback()&&(n=(t=[e,n])[0],e=t[1]),n?i(n):i(null,new o(e,a,s))})})},e)}},{key:"CollectionHandler",get:function(){return ze}},{key:"Action",get:function(){return Xe}},{key:"FailedMessageEventActionReason",get:function(){return Ye}}]),o}();"undefined"==typeof Promise&&(Promise=e);var Nn=null,xn=null,Fn=null,Pn=ue,Ln=null,qn=null,Bn=null,Vn=null,jn=function(){function a(){return l(this,a),xn=xn||this}return c(a,[{key:"resumeSync",value:function(){Se.call("resumeSync()"),qn&&qn.start(),Bn&&Bn.start()}},{key:"pauseSync",value:function(){Se.call("pauseSync()"),qn&&qn.stop(),Bn&&Bn.stop()}},{key:"clearCache",value:function(e){return Se.call("clearCache()"),xe(function(n){var e=[];qn&&e.push(new Promise(function(n,t){qn.reset(function(e){return e?t(e):n()})})),Bn&&e.push(new Promise(function(n,t){Bn.reset(function(e){return e?t(e):n()})})),0<e.length?Promise.all(e).then(function(){return n(null)}).catch(function(e){return n(e)}):n(null)},e)}},{key:"reset",value:function(e){var t=this;return Se.call("reset()"),xe(function(n){t.clearCache(function(e){e||(fn.clear(function(){qn=null}),sn.clear(function(){Bn=null})),n(e)})},e)}},{key:"currentUserId",get:function(){return Nn&&Nn.currentUser?Nn.currentUser.userId:Fn}}],[{key:"setup",value:function(e,n,t){Se.call("init()"),Vn=new a.Options;var i=arguments.length<=0?void 0:e,e=arguments.length<=1?void 0:n;return e&&"function"!=typeof e&&(e instanceof a.Options?(Vn=e,e=arguments.length<=2?void 0:t):Se.error("Type of the second parameter is not valid: ",arguments.length<=1?void 0:n)),Se.prefix="[SyncManager]",xe(function(r){Ee.init(),Nn?(xn=new a,Ee.get("lastUserId").then(function(t){Fn=i,fn.clear(),qn=null,sn.clear(),Bn=null,Ln?(Se.cache("Database is open"),Ee.set("lastUserId",i).then(function(){qn=new fn({sendBird:Nn,db:Ln}),Bn=new sn({sendBird:Nn,db:Ln}),a.ChannelCollection=In,a.MessageCollection=Dn,t&&t!==i&&(Se.warning("Different user ID: clear cache"),xn.clearCache(function(){})),nn.getInstance().removeExpiredMessages(function(){Se.message("Expired messages are removed.")}),r(null)}).catch(function(e){r(e)})):X().then(function(e){e&&(Se.info("IndexedDB is not supported in private browsing mode in Edge/Firefox. Using in-memory database."),Pn=ke);var n=new Pn("sbsync.db",5);n.schema("GroupChannel",{key:"url",index:[{ownerUserId:Pn.Query.Order.ASC,lastMessageUpdatedAt:Pn.Query.Order.DESC},{ownerUserId:Pn.Query.Order.ASC,createdAt:Pn.Query.Order.DESC},{ownerUserId:Pn.Query.Order.ASC,name:Pn.Query.Order.ASC}]}).schema("GroupChannelListQuery",{key:"filterKey",index:[{ownerUserId:Pn.Query.Order.ASC,updatedAt:Pn.Query.Order.DESC}]}).schema("MessageChunk",{key:"chunkId",index:[{ownerUserId:Pn.Query.Order.ASC,channelUrl:Pn.Query.Order.ASC,filterKey:Pn.Query.Order.ASC,endAt:Pn.Query.Order.DESC}]}).schema("Message",{key:"messageId",index:[{ownerUserId:Pn.Query.Order.ASC,channelUrl:Pn.Query.Order.ASC,createdAt:Pn.Query.Order.DESC},{ownerUserId:Pn.Query.Order.ASC,createdAt:Pn.Query.Order.ASC}]}).build().then(function(){Se.cache("Database is open"),Ln=n,Ee.set("lastUserId",i).then(function(){qn=new fn({sendBird:Nn,db:Ln}),Bn=new sn({sendBird:Nn,db:Ln}),a.ChannelCollection=In,a.MessageCollection=Dn,t&&t!==i&&(Se.warning("Different user ID: clear cache"),xn.clearCache(function(){})),nn.getInstance().removeExpiredMessages(function(){Se.message("Expired messages are removed.")}),r(null)}).catch(function(e){r(e)})}).catch(function(e){return r(e)})})}).catch(function(e){r(e)})):r(_e.create(_e.Type.ERROR_SETUP_MISSING))},e)}},{key:"useReactNative",value:function(e){Ee.useReactNative(e),H.Storage=e,Pn=H}},{key:"getInstance",value:function(){return xn}},{key:"sendBird",get:function(){return Nn},set:function(e){(Nn=e)&&Nn.addExtension("sb_syncmanager","1.1.21")}},{key:"LocalDB",get:function(){return Pn}},{key:"_messageContainer",get:function(){return sn.getInstance().messageContainer}},{key:"_chunkContainer",get:function(){return sn.getInstance().chunkContainer}},{key:"syncManagerOptions",get:function(){return Vn||new a.Options}},{key:"LogLevel",get:function(){return we}},{key:"loggerLevel",set:function(e){Se.level=e},get:function(){return Se.level}}]),a}();return jn.Options=function(){return function e(){l(this,e);var n=1e3;Object.defineProperty(this,"messageCollectionCapacity",{get:function(){return n},set:function(e){"number"==typeof e&&e>=(Se.isValidLevel(Se.level)?200:0)&&e<=Number.MAX_SAFE_INTEGER&&(n=e)}});var t=jn.Options.MessageResendPolicy.NONE;Object.defineProperty(this,"messageResendPolicy",{get:function(){return t},set:function(e){-1<Object.keys(jn.Options.MessageResendPolicy).map(function(e){return jn.Options.MessageResendPolicy[e]}).indexOf(e)&&(t=e)}});var r=10;Object.defineProperty(this,"automaticMessageResendRetryCount",{get:function(){return r},set:function(e){"number"==typeof e&&0<e&&e<=50&&(r=e)}});var i=20;Object.defineProperty(this,"maxFailedMessageCountPerChannel",{get:function(){return i},set:function(e){"number"==typeof e&&0<e&&e<=Number.MAX_SAFE_INTEGER&&(i=e)}});var a=7;Object.defineProperty(this,"failedMessageRetentionDays",{get:function(){return a},set:function(e){"number"==typeof e&&(e>(Se.isValidLevel(Se.level)?0:-2)&&e<=Number.MAX_SAFE_INTEGER||e===jn.Options.INFINITY)&&(a=e)}})}}(),jn.Options.MessageResendPolicy={NONE:"none",MANUAL:"manual",AUTOMATIC:"automatic"},jn.Options.INFINITY=Number.MAX_SAFE_INTEGER,jn});